{% extends 'layoutAdmin.html.twig' %}
{% block Head %}
	{{ parent() }}

	{% block LinksCss %}
		{{ parent() }}
        <link rel="stylesheet" href="{{ asset ('css/carousel.css') }}">
        <link rel="stylesheet" href="{{ asset ('css/carouselle.css') }}">
        <link rel="stylesheet" href="{{ asset ('css/fontawesome.css') }}">
        <link rel="stylesheet" href="{{ asset ('css/style-topRate.css') }}">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

       <style>.stat-big-card {
    display: flex;
    align-items: center;
    padding: 20px;
    border-radius: 14px;
    color: #fff;
    height: 180px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    transition: 0.3s;
    position: relative;
    margin-bottom: 5%;
}

.stat-big-card:hover {
    transform: translateY(-5px);
}

.stat-big-icon {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: rgba(255,255,255,0.25);
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 32px;
    margin-right: 15px;
}

.stat-big-title {
    font-size: 14px;
    opacity: 0.85;
}

.stat-big-value {
    font-size: 32px;
    font-weight: 700;
    margin-top: 10px;
}

</style>
	{% endblock %}

{% endblock %}

{% block title %}
	Dashboard!
{% endblock %}
{% block loader %} {{ parent() }} {% endblock %}
{% block sidebar %}
	{{ parent() }}

{% endblock %}

{% block page %}
	{{ parent() }}
    
<div class="px-15px px-lg-25px">
    <div class="row gutters-10">

        <!-- Cards statistiques -->
        <div class="col-lg-12">
            <div class="row g-4">

                <!-- Visiteurs Aujourd'hui -->
                <div class="col-12 col-sm-6 col-md-4">
                    <div class="stat-big-card" style="background: linear-gradient(135deg,#6c5ce7,#a29bfe);">
                        <div class="stat-big-icon">
                            <i class="las la-eye"></i>
                        </div>
                        <div>
                            <div class="stat-big-title">TOTAL</div>
                            <h6 class="fw-bold mb-0">Visiteurs Aujourd'hui</h6>
                            <div class="stat-big-value" id="visitorCount">{{ visitorsToday ?? 0 }}</div>
                        </div>
                    </div>
                </div>

                <!-- Propriétaires -->
                <div class="col-12 col-sm-6 col-md-4">
                    <div class="stat-big-card" style="background: linear-gradient(135deg,#5d78ff,#34bfa3);">
                        <div class="stat-big-icon">
                            <i class="las la-user-tie"></i>
                        </div>
                        <div>
                            <div class="stat-big-title">TOTAL</div>
                            <h6 class="fw-bold mb-0">Propriétaires</h6>
                            <div class="stat-big-value" id="proprietaires-count">{{ nbProprietaires ?? 0 }}</div>
                        </div>
                    </div>
                </div>

                <!-- Mécaniciens -->
                <div class="col-12 col-sm-6 col-md-4">
                    <div class="stat-big-card" style="background: linear-gradient(135deg,#fd3995,#fdcb6e);">
                        <div class="stat-big-icon">
                            <i class="las la-tools"></i>
                        </div>
                        <div>
                            <div class="stat-big-title">TOTAL</div>
                            <h6 class="fw-bold mb-0">Mécaniciens</h6>
                            <div class="stat-big-value" id="mecaniciens-count">{{ nbMecaniciens ?? 0 }}</div>
                        </div>
                    </div>
                </div>

                <!-- Vendeurs Neuf -->
                <div class="col-12 col-sm-6 col-md-4">
                    <div class="stat-big-card" style="background: linear-gradient(135deg,#34bfa3,#5d78ff);">
                        <div class="stat-big-icon">
                            <i class="las la-store"></i>
                        </div>
                        <div>
                            <div class="stat-big-title">TOTAL</div>
                            <h6 class="fw-bold mb-0">Vendeurs de pièces neuves</h6>
                            <div class="stat-big-value" id="vendeurs-neuf-count">{{ nbVendNeuve ?? 0 }}</div>
                        </div>
                    </div>
                </div>

                <!-- Vendeurs Occasion -->
                <div class="col-12 col-sm-6 col-md-4">
                    <div class="stat-big-card" style="background: linear-gradient(135deg,#fdcb6e,#d35400);">
                        <div class="stat-big-icon">
                            <i class="las la-recycle"></i>
                        </div>
                        <div>
                            <div class="stat-big-title">TOTAL</div>
                            <h6 class="fw-bold mb-0">Vendeurs de pièces occasion</h6>
                            <div class="stat-big-value" id="vendeurs-occasion-count">{{ nbVendOccasion ?? 0 }}</div>
                        </div>
                    </div>
                </div>

                <!-- Particuliers -->
                <div class="col-12 col-sm-6 col-md-4">
                    <div class="stat-big-card" style="background: linear-gradient(135deg,#34bfa3,#5d78ff);">
                        <div class="stat-big-icon">
                            <i class="las la-user"></i>
                        </div>
                        <div>
                            <div class="stat-big-title">TOTAL</div>
                            <h6 class="fw-bold mb-0">Particuliers</h6>
                            <div class="stat-big-value" id="particuliers-count">{{ nbParticulier ?? 0 }}</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Graphiques -->
        <div class="col-lg-12 mt-4">
            <div class="row gutters-10">

                <div class="col-12 col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0 fs-14">Demandes</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="pie-1" style="width:100%; max-width:400px; height:300px;"></canvas>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0 fs-14">Offres</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="pie-3" style="width:100%; max-width:400px; height:300px;"></canvas>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0 fs-14">Annonces</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="pie-2" style="width:100%; max-width:400px; height:300px;"></canvas>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Nombre de demandes et offres par jour -->
        <div class="col-lg-12 mt-4">
            <div class="row gutters-10">

                <div class="col-12">
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0 fs-14">Nombre de demande par jour</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="myChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0 fs-14">Nombre de offre par jour</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="offresChart"></canvas>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

{% endblock %}


{% block javascript %}
	{{ parent() }}
   
	 <script type="text/javascript" src="{{asset ('js/carousel.js') }}"> </script>

     <script type="text/javascript">

      $(document).ready(function() {
    var table = $('#tab01').DataTable( {
       language: {
             "url": "//cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/French.json"
         },
        rowReorder: {
            selector: 'td:nth-child(2)'
        },
        responsive: true
    } );
} );


  $(document).ready(function() {
    var table = $('#tab02').DataTable( {
       language: {
             "url": "//cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/French.json"
         },
        rowReorder: {
            selector: 'td:nth-child(2)'
        },
        responsive: true
    } );
} );

 
   AIZ.plugins.chart('#pie-2', {
    type: 'doughnut',
    data: {
        labels: [
            'Annonces en attente',
            'Annonces publiées',
            'Annonces vendues'
        ],
        datasets: [
            {
                data: [
                    {{ totalAnnoncesAttente }},
                    {{ totalAnnoncesPublie }},
                    {{ totalAnnoncesVendu }}
                ],
                backgroundColor: [
                    "#fdcb6e",
                    "#5d78ff",
                    "#34bfa3"
                ]
            }
        ]
    },
    options: {
        cutoutPercentage: 70,
        legend: {
            labels: {
                fontFamily: 'Montserrat',
                boxWidth: 10,
                usePointStyle: true
            },
            onClick: function () {
                return '';
            },
            position: 'bottom'
        }
    }
});


    
</script>
<script>
let ctx = document.getElementById('demandeChart').getContext('2d');
let demandeChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            label: 'Nombre de demandes par jour',
            data: [],
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 2,
            tension: 0.3
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'top' }
        },
        scales: {
            y: { beginAtZero: true, precision: 0 }
        }
    }
});

// Fonction pour mettre à jour le graphique
function updateChart() {
    $.ajax({
        url: '{{ path("dashboard_demandes_data") }}',
        type: 'GET',
        success: function(response) {
            demandeChart.data.labels = response.labels;
            demandeChart.data.datasets[0].data = response.data;
            demandeChart.update();
        }
    });
}

// Rafraîchissement toutes les 5 secondes
updateChart(); // première récupération
setInterval(updateChart, 50000);
</script>


<script>
function updateVisitorCount() {
    fetch('{{ path('visiteurs_total') }}')
        .then(response => response.json())
        .then(data => {
            document.getElementById('visitorCount').textContent = data.total;
        })
        .catch(error => console.error('Erreur:', error));
}

// Mise à jour toutes les 10 secondes
setInterval(updateVisitorCount, 10000);

// Premier chargement
updateVisitorCount();
</script>
<script>
function updateUserStats() {
    fetch('{{ path('stats_users_role') }}')
        .then(response => response.json())
        .then(data => {
            document.getElementById('proprietaires-count').textContent = data.proprietaires;
            document.getElementById('mecaniciens-count').textContent = data.mecaniciens;
            document.getElementById('vendeurs-neuf-count').textContent = data.vendeursNeuf;
            document.getElementById('vendeurs-occasion-count').textContent = data.vendeursOccasion;
            document.getElementById('particuliers-count').textContent = data.particuliers;
        });
}

// Actualisation toutes les 5 secondes
setInterval(updateUserStats, 500);
</script>

<script>
let pieChart;

function updateDemandesChart() {
    fetch("{{ path('dashboard_demandes_stats') }}")
        .then(response => response.json())
        .then(data => {

            const chartData = [
                data.demandesNeuf,
                data.demandesOccasion,
                data.totalDemandes
            ];

            // Si le chart existe déjà, on met à jour les données
            if (pieChart) {
                pieChart.data.datasets[0].data = chartData;
                pieChart.update();
            } else {
                // Création du chart la première fois
                pieChart = AIZ.plugins.chart('#pie-1', {
                    type: 'doughnut',
                    data: {
                        labels: [
                            'Total demande neuf',
                            'Total demande occasion',
                            'Total demande'
                        ],
                        datasets: [{
                            data: chartData,
                            backgroundColor: [
                                "#fd3995",
                                "#34bfa3",
                                "#5d78ff"
                            ]
                        }]
                    },
                    options: {
                        cutoutPercentage: 70,
                        legend: {
                            labels: {
                                fontFamily: 'Poppins',
                                boxWidth: 10,
                                usePointStyle: true
                            },
                            onClick: function () {
                                return '';
                            },
                            position: 'bottom'
                        }
                    }
                });
            }

        }).catch(err => console.error('Erreur fetch chart:', err));
}

// Actualisation toutes les 5 secondes
setInterval(updateDemandesChart, 50000);

// Premier appel immédiat
updateDemandesChart();
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {

    let ctx = document.getElementById("myChart").getContext('2d');
    let commandGraph = new Chart(ctx, {
        type: "line",
        data: {
            labels: [], // remplis par fetch
            datasets: [
                {
                    label: "Demandes Neuve",
                    data: [],
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    fill: false,
                },
                {
                    label: "Demandes Occasion",
                    data: [],
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 2,
                    fill: false,
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    stepSize: 1
                }
            }
        }
    });

    // fetch les données depuis Symfony
    fetch('{{ path("dashboard_demandes_data") }}')
        .then(res => res.json())
        .then(res => {
            commandGraph.data.labels = res.labels;
            commandGraph.data.datasets[0].data = res.neuf;
            commandGraph.data.datasets[1].data = res.occasion;
            commandGraph.update();
        })
        .catch(err => console.error('Erreur fetch:', err));

});
</script>
<script>
let pieOffresChart;

function updateOffresChartDonut() {
    fetch("{{ path('dashboard_offres_data') }}", {
        headers: {'Accept': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {

        const chartData = [
            data.refuse,
            data.accepte,
            data.total,
            data.en_attente
        ];

        if (pieOffresChart) {
            pieOffresChart.data.datasets[0].data = chartData;
            pieOffresChart.update();
        } else {
            pieOffresChart = AIZ.plugins.chart('#pie-3', {
                type: 'doughnut',
                data: {
                    labels: [
                        'Offres annulées',
                        'Offres acceptées',
                        'Total offres',
                        'Offres en attente'
                    ],
                    datasets: [{
                        data: chartData,
                        backgroundColor: [
                            "#fd3995",
                            "#34bfa3",
                            "#5d78ff",
                            "#fdcb6e"
                        ]
                    }]
                },
                options: {
                    cutoutPercentage: 70,
                    legend: {
                        position: 'bottom'
                    }
                }
            });
        }

    }).catch(err => console.error('Erreur fetch chart offres:', err));
}

setInterval(updateOffresChartDonut, 50000);
updateOffresChartDonut();

</script>
<script>
let ctxOffres = document.getElementById('offresChart').getContext('2d');
let offresChart = new Chart(ctxOffres, {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            label: 'Nombre d\'offres par jour',
            data: [],
            backgroundColor: 'rgba(255, 206, 86, 0.2)',
            borderColor: 'rgba(255, 206, 86, 1)',
            borderWidth: 2,
            tension: 0.3
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'top' }
        },
        scales: {
            y: { beginAtZero: true, precision: 0 }
        }
    }
});

// Fonction pour mettre à jour le graphique des offres
function updateOffresJourChart() {
    $.ajax({
        url: '{{ path("dashboard_offres_jour") }}',
        type: 'GET',
        success: function(response) {
            offresChart.data.labels = response.labels;
            offresChart.data.datasets[0].data = response.offres;
            offresChart.update();
        },
        error: function(err) {
            console.error("Erreur fetch offres par jour:", err);
        }
    });
}

// Rafraîchissement toutes les 5 secondes
updateOffresJourChart(); // premier appel
setInterval(updateOffresJourChart, 5000);
</script>
{% endblock %}
