{% extends 'layoutAdmin.html.twig' %}

{% block title %}Gestion Page vendeur occasion{% endblock %}

{% block LinksCss %}
    {{ parent() }}
{% endblock %}

{% block page %}
{{ parent() }}
{% block loader %} {{ parent() }} {% endblock %}

<div class="px-15px px-lg-25px">

    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h6>Modifier la page vendeur occasion</h6>
                </div>
                <div class="card-body">
                    <form id="pageProprietaireForm">
                        <input type="hidden" name="_token" value="{{ csrf_token('update_page') }}">
                        
                        <!-- Description -->
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="description" name="description" class="form-control" rows="4">{{ invitePage ? invitePage.description : '' }}</textarea>
                        </div>

                        <!-- Vidéo -->
                        <div class="form-group mt-3">
                            <label>Vidéo</label>
                            <div class="input-group mb-2">
                                <div class="input-group-prepend">
                                    <div class="input-group-text" style="cursor:pointer;" onclick="uploadVideoCloudinary()">
                                        Parcourir
                                    </div>
                                </div>
                                <input type="hidden" id="videoPath" name="video" value="{{ invitePage ? invitePage.videoPath : '' }}">
                            </div>

                            <video id="previewVideo"
                                   src="{{ invitePage ? invitePage.videoPath : '' }}"
                                   controls
                                   style="margin-top:10px; width:100%; max-width:300px; aspect-ratio:9/16; border-radius:10px; object-fit:cover; display: {{ invitePage and invitePage.videoPath ? 'block' : 'none' }};">
                            </video>
                        </div>

                        <div class="text-right mt-3">
                            <button type="button" class="btn btn-custom rounded-pill fw-bold fs-14 px-4 py-2" onclick="savePage()">Sauvegarder</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block javascript %}
{{ parent() }}

<script>
cloudinary.setCloudName('b-ja'); // Remplace par ton cloudName

function uploadVideoCloudinary() {
       $('#cloudinaryPreloader').show();
    cloudinary.openUploadWidget({
       
        cloud_name: 'b-ja',
        upload_preset: 'aladdineshop',
        folder: 'aladsine',
        sources: ['local', 'url'],
        multiple: false,
        resource_type: 'video',
        client_allowed_formats: ["mp4","mov","avi"],
        max_file_size: 500000000
    }, (error, result) => {
         $('#cloudinaryPreloader').hide();
        if (!error && result && result.event === "success") {
            console.log(result.info.secure_url);
            $('#previewVideo').attr('src', result.info.secure_url).show();
            $('#videoPath').val(result.info.secure_url);
        } else if(error){
            Swal.fire('Erreur', 'Erreur lors de l\'upload vidéo: ' + error.message, 'error');
        }
    });
}

function savePage(){
    const description = $('#description').val();
    const videoPath = $('#videoPath').val();

    $.ajax({
        url: '{{ path("admin_invite_vendeur_occ_update") }}',
        method: 'POST',
        data: {
            description: description,
            videoPath: videoPath,
            _token: '{{ csrf_token("update_page") }}'
        },
        success: function(res){
            if(res.status === 'success'){
                Swal.fire('Succès', res.message, 'success');
            } else {
                Swal.fire('Erreur', res.message, 'error');
            }
        },
        error: function(){
            Swal.fire('Erreur', 'Impossible de sauvegarder la page.', 'error');
        }
    });
}
</script>
{% endblock %}
