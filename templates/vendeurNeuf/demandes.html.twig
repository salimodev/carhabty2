{% extends 'vendeurNeuf/layoutVN.html.twig' %}
{% block Head %}
	{{ parent() }}

	{% block LinksCss %}
		{{ parent() }}
		<link rel="stylesheet" href="{{ asset ('css/carousel.css') }}">
		<link rel="stylesheet" href="{{ asset ('css/carouselle.css') }}">
		<link rel="stylesheet" href="{{ asset ('css/fontawesome.css') }}">
		<link rel="stylesheet" href="{{ asset ('css/stylebutton.css') }}">
		<style>


			.btn:hover {
				color: #ffffff !important;
				text-decoration: none;
			}
			.btn-register:hover {
				background: linear-gradient(45deg, #ff8c00, #ff6b35);
				transform: translateY(-2px);
			}
			.request-card {
				background: linear-gradient(135deg, #ffffff, #f7f8fc);
				border-radius: 15px;
				box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
				padding: 15px;
				transition: all 0.3s ease;
			}

			.request-card:hover {
				transform: translateY(-4px);
				box-shadow: 0 8px 20px rgba(255, 107, 53, 0.3);
			}

			.request-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 10px;
			}

			.request-title {
				font-weight: 700;
				font-size: 16px;
				color: #222;
				line-height: 1.3;
				flex: 1;
			}

			.request-badge {
				background: linear-gradient(135deg, #ff6b35 0%, #fca311 50%, #2ec4b6 100%);
				color: #fff;
				font-size: 12px;
				border-radius: 12px;
				padding: 5px 12px;
				font-weight: 700;
				letter-spacing: 0.5px;
				text-transform: uppercase;
				box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
				display: inline-block;
				transition: all 0.3s ease;
			}

			.request-badge:hover {
				transform: scale(1.05);
				box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
			}
			.request-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 8px;
			}


			.request-meta {
				font-size: 13px;
				color: #666;
				display: flex;
				justify-content: space-between;
				flex-wrap: wrap;
				gap: 4px;
				margin-bottom: 10px;
			}

			.request-image img {
				width: 100%;
				height: 220px;
				object-fit: cover;
				border-radius: 10px;
				margin-bottom: 10px;
			}

			.request-description {
				font-size: 14px;
				color: #333;
				line-height: 1.4;
				min-height: 50px;
				margin-bottom: 10px;
			}

			.request-meta {
				display: flex;
				flex-wrap: wrap;
				gap: 10px;
				color: #555;
				font-size: 14px;
				align-items: center;
				margin-bottom: 10px;
			}

			.request-meta i {
				color: #ff6b35;
				margin-right: 5px;
				font-size: 15px;
			}

			.btn-register i {
				margin-right: 8px;
				font-size: 16px;
				color: #fff;
			}
			.btn-register {
				background: linear-gradient(45deg, #ff6b35, #ff8c00);
				border: none;
				color: white;
				font-weight: 600;
				transition: 0.3s ease;
			}
			.btn-register:hover {
				background: linear-gradient(45deg, #ff8c00, #ff6b35);
				transform: translateY(-2px);
			}
			/* Effet au survol */
			.btn-register:hover {
				background: linear-gradient(45deg, #ff8c00, #ff6b35);
				transform: translateY(-2px);
				box-shadow: 0 4px 10px rgba(255, 107, 53, 0.4);
			}

			/* Animation de l'enveloppe quand la carte est survol√©e */
			.request-card:hover .btn-register i {
				animation: vibrate 0.3s linear infinite;
			}

			@keyframes vibrate {
				0% {
					transform: rotate(0deg);
				}
				25% {
					transform: rotate(10deg);
				}
				50% {
					transform: rotate(-10deg);
				}
				75% {
					transform: rotate(10deg);
				}
				100% {
					transform: rotate(0deg);
				}
			}
			/* üì± Responsive fixes */
			@media(max-width: 768px) {
				.request-card {
					padding: 12px;
					min-height: auto;
				}
				.request-title {
					font-size: 15px;
				}
				.request-meta {
					font-size: 12px;
				}
				.request-image img {
					height: 180px;
				}
			}


			.btn-propdemande {
				background: linear-gradient(45deg, #ff6b35, #ff9f1c);
				background: linear-gradient(45deg, #2ec4b6, #ff9f1c);
				color: white;
				box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
			}


			.btn-offer {
				background-color: #ff4d00;
				color: white;
				border: none;
				width: 100%;
				padding: 10px;
				border-radius: 10px;
				font-weight: 600;
				cursor: pointer;
				transition: background 0.2s ease;
			}
			.btn-offer:hover {
				background-color: #e64300;
			}

			.badge-custom {
				display: inline-block;
				padding: 3px;
				font-size: 11px;
				border-radius: 0 50em 50em 0;
				color: #ffffff;
				font-weight: 600;
				line-height: 23px;
				position: absolute;
				background: linear-gradient(45deg, #ff6b35, #ff9f1c);
				z-index: 1;
				top: 20px;
				box-shadow: 2px 1px 6px 2px rgb(0 0 0 / 10%), 0 4px 4px 0 rgb(0 0 0 / 15%) !important;
			}
			.badge-custom .box {
				height: 26px;
				width: 26px;
				background: linear-gradient(45deg, #ff6b35, #ff9f1c);
				color: #fff;
				display: inline-block;
				border-radius: 50%;
				text-align: center;
			}
		</style>
	{% endblock %}

{% endblock %}

{% block title %}Tableau de bord
{% endblock %}
{% block Header %}
	{{ parent() }}
{% endblock %}


{% block page %}
	{{ parent() }}
	{% block loader %}
		{{ parent() }}
	{% endblock %}
	{% if app.user %}
		{% if is_granted('ROLE_VENDEUR_NEUF') %}
			<section class="mb-4 pt-3">
				<div class="container sm-px-0">
					<form class="" id="search-form" action="" method="GET">
						<div class="row">

							<div class="col-xl-12">


								<div class="text-left">
									<div class="row gutters-5 flex-wrap align-items-center">
										<div class="col col-10">
											<h1 class="h6 fw-600 text-body">
												Demandes
											</h1>
										</div>
										<div
											class="row justify-content-end align-items-end g-2 mb-4 filtre-demandes">

											<!-- Filtre Marque -->
											<div class="col-6 col-md-auto">
												<label class="mb-0 opacity-50 small">Marque</label>
												<select class="form-control form-control-sm" onchange="filtrerDemandesNeuf()" id="marque" data-live-search="true">
													<option value="">Toutes les marques</option>
													<option value="Audi">Audi</option>
													<option value="BMW">BMW</option>
													<option value="Mercedes">Mercedes</option>
													<option value="Toyota">Toyota</option>
												</select>
											</div>

											<!-- Filtre Zone -->

											<!-- Filtre Date -->
											<div class="col-6 col-md-auto">
												<label class="mb-0 opacity-50 small">Date</label>
												<select class="form-control form-control-sm" onchange="filtrerDemandesNeuf()" id="date">
													<option value="recent">Le plus r√©cent</option>
													<option value="ancien">Le plus ancien</option>
												</select>
											</div>

											<!-- Filtre Type -->


										</div>


									</div>
								</div>
								<input type="hidden" name="min_price" value="">
								<input type="hidden" name="max_price" value="">
								<div class="row gutters-5 row-cols-xxl-3 row-cols-xl-3 row-cols-lg-3 row-cols-md-2 row-cols-1" id="filterrech">
									{% for demande in demandes %}
									 {% if demande.statut != 'fermer' %}
										<div class="col mb-3">
											<div class="carousel-box">
												<div
													class="request-card">

													{# Titre cliquable #}
													<a href="{{ path('detail_demande_vendeur', {'id': demande.id}) }}" class="text-decoration-none text-dark">
														<div class="request-header">
															<div class="request-title">
																{% if demande.pieces|length > 0 %}
																	{% for piece in demande.pieces %}
																		{{ demande.marque }}
																		{{ piece.designation }}
																		{% if not loop.last %},
																		{% endif %}
																	{% endfor %}
																{% else %}
																	{{ demande.marque }}
																	{{ demande.modele }}
																{% endif %}
															</div>
															<div class="request-badge">
																{% if demande.vendeuroccasion == 1 %}
																	Occasion
																{% else %}
																	Neuf
																{% endif %}
															</div>
														</div>
													</a>

													{# Meta info #}
													<div class="request-meta">
														<span>
															<i class="fas fa-map-marker-alt"></i>
															{{ demande.zone }}</span>
														<span>
															<i class="fas fa-user"></i>
															{{ demande.offrecompte ? demande.offrecompte.nom : 'Anonyme' }}</span>
														<span>
															<i class="far fa-clock"></i>
															{{ demande.datecreate|time_ago }}</span>
													</div>

													{# Image cliquable #}
													<a href="{{ path('detail_demande_vendeur', {'id': demande.id}) }}">
														<div class="request-image">
															{% set photo = (demande.pieces|first).photo ?? '/assets/img/placeholder.png' %}
															<img src="{{ photo }}" alt="photo" class="img-fit mx-auto rounded">
														</div>
													</a>

													{# Description #}
													<p class="request-description">
														{% if demande.pieces|length > 0 %}
															{% for piece in demande.pieces|slice(0,3) %}
																{{ piece.observation }}
																{% if not loop.last %},
																{% endif %}
															{% endfor %}
															{% if demande.pieces|length > 3 %}...
															{% endif %}
														{% else %}
															Pas de description disponible.
														{% endif %}
													</p>

													{% set dejaPropose = demande.offres|filter(o => o.user.id == app.user.id)|length > 0 %}

													<a href="{% if not dejaPropose %}{{ path('propose_offre', {'id': demande.id}) }}{% else %}#{% endif %}" class="btn btn-register btn-circle w-100 text-center" {% if dejaPropose %} onclick="AIZ.plugins.notify('danger', 'Vous avez d√©j√† propos√© une offre pour cette demande !'); return false;" {% endif %}>
														<i class="fas fa-envelope-open-text me-2"></i>
														Proposer un prix
													</a>


												</div>
											</div>
										</div>
										{% endif %}
									{% endfor %}

								</div>
							</div>
						</div>
						<div class="aiz-pagination aiz-pagination-center mt-4">
							{{ knp_pagination_render(demandes) }}
						</div>

					</form>
				</div>
			</section>


		{% endif %}
	{% endif %}
{% endblock %}
{% block footer %}
	{{ parent() }}
{% endblock %}
{% block javascript %}
	{{ parent() }}<script type="text/javascript" src="{{asset ('assets/js/carousel.js') }}"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script type="text/javascript"></script>
	<script type="text/javascript">
		$(document).ready(function () {
var table = $('#tabprod').DataTable({
language: {
processing: "Traitement en cours...",
search: "Rechercher :",
lengthMenu: "Afficher _MENU_ √©l√©ments",
info: " _START_-_END_/_TOTAL_ √©l√©ments",
infoEmpty: " 0 -  0 / 0 √©l√©ments",
infoFiltered: "(filtr√© de _MAX_ √©l√©ments au total)",
infoPostFix: "",
loadingRecords: "Chargement en cours...",
zeroRecords: "Aucun √©l√©ment √† afficher",
emptyTable: "Aucun √©l√©ment √† afficher",
paginate: {
first: "Premier",
previous: "Pr√©c√©dent",
next: "Suivant",
last: "Dernier"
}
},
rowReorder: {
selector: 'td:nth-child(2)'
},
responsive: true
});
});


$(document).ready(function () {
var table = $('#tabprod1').DataTable({
language: {
processing: "Traitement en cours...",
search: "Rechercher :",
lengthMenu: "Afficher _MENU_ √©l√©ments",
info: " _START_-_END_/_TOTAL_ √©l√©ments",
infoEmpty: " 0 -  0 / 0 √©l√©ments",
infoFiltered: "(filtr√© de _MAX_ √©l√©ments au total)",
infoPostFix: "",
loadingRecords: "Chargement en cours...",
zeroRecords: "Aucun √©l√©ment √† afficher",
emptyTable: "Aucun √©l√©ment √† afficher",
paginate: {
first: "Premier",
previous: "Pr√©c√©dent",
next: "Suivant",
last: "Dernier"
}
},
rowReorder: {
selector: 'td:nth-child(2)'
},
responsive: true
});
});

function timeAgo(dateString) {
var now = new Date();
var past = new Date(dateString);
var diff = Math.floor((now - past) / 1000); // en secondes

if (diff < 60) 
return '√† l\'instant';

if (diff < 3600) 
return Math.floor(diff / 60) + 'il y a minute(s) ';

if (diff < 86400) 
return Math.floor(diff / 3600) + 'il y a heure(s) ';

if (diff < 2592000) 
return Math.floor(diff / 86400) + 'il y a jour(s) ';

return past.toLocaleDateString(); // ou "d/m/Y" selon besoin
}

function filtrerDemandesNeuf() {
var url = "{{ path('recherche_demande_vendeur_neuf') }}"; // route AJAX

var marque = $('#marque').val();
var date = $('#date').val();

var data = {
marque: marque,
date: date,
type: 'neuf'
};

$.ajax({
type: "POST",
url: url,
data: data,
success: function (demandes) {
var html = "";

if (demandes.length === 0) {
html = `<div class="text-center p-3" style="margin: auto">
                            <i class="las la-frown la-3x opacity-60 mb-3"></i>
                            <h3 class="h6 fw-700">Aucune demande trouv√©e</h3>
                        </div>`;
} else {
demandes.forEach(function (d) {
var piecesTitle = "";
var piecesDesc = "";
if (d.pieces && d.pieces.length > 0) {
piecesTitle = d.pieces.map(p => p.designation).join(", ");
piecesDesc = d.pieces.slice(0, 3).map(p => p.observation).join(", ");
if (d.pieces.length > 3) 
piecesDesc += "...";

}

var dejaPropose = d.dejaPropose || false;

// üîó lien vers la page de d√©tail
var lienDetail = "{{ path('detail_demande_vendeur', {'id': 'ID_DEMANDE'}) }}";
lienDetail = lienDetail.replace('ID_DEMANDE', d.id);

html += `
<div class="col mb-3">
    <div class="carousel-box">
        <div class="request-card">
            <div class="request-header">
                <a href="${lienDetail}" class="text-decoration-none text-dark">
                    <div class="request-title">${
piecesTitle || (d.marque + " " + d.modele)
}</div>
                </a>
                <div class="request-badge">Neuf</div>
            </div>
            <div class="request-meta">
                <span><i class="fas fa-map-marker-alt"></i> ${d.zone}</span>
                <span><i class="fas fa-user"></i> ${d.offrecompte}</span>
                <span><i class="far fa-clock"></i> ${timeAgo(d.date)}</span>
            </div>
            <a href="${lienDetail}" class="text-decoration-none">
                <div class="request-image">
                    <img src="${
(d.pieces[0] && d.pieces[0].photo) || '/assets/img/placeholder.png'
}"
                         alt="photo" class="img-fit mx-auto rounded">
                </div>
            </a>
            <p class="request-description">${
piecesDesc || 'Pas de description disponible.'
}</p>
            <button class="btn btn-register w-100 propose-btn" data-id="${
d.id
}" data-deja="${dejaPropose}">
                <i class="fas fa-envelope-open-text"></i> Proposer un prix
            </button>
        </div>
    </div>
</div>`;
});
}

$('#filterrech').html(html);

// clic bouton proposer un prix
$('#filterrech').find('.propose-btn').each(function () {
$(this).on('click', function (e) {
e.preventDefault();
let deja = $(this).data('deja');
let demandeId = $(this).data('id');

if (deja) {
AIZ.plugins.notify('danger', 'Vous avez d√©j√† propos√© une offre pour cette demande !');
} else {
let url = "{{ path('propose_offre', {'id': 'ID_DEMANDE'}) }}";
url = url.replace('ID_DEMANDE', demandeId);
window.location.href = url;
}
});
});

},
beforeSend: function () {
$('#loaderAcc1').show();
},
complete: function () {
$('#loaderAcc1').hide();
}
});
}
	</script>
{% endblock %}

