{% extends 'vendeurOccasion/layoutVO.html.twig' %}

{% block Head %}
    {{ parent() }}
    {% block LinksCss %}
        {{ parent() }}
        <link rel="stylesheet" href="{{ asset('css/fontawesome.css') }}">
        <link rel="stylesheet" href="{{ asset('css/stylebutton.css') }}">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
    {% endblock %}
{% endblock %}

{% block title %}Proposer une offre{% endblock %}

{% block page %}
    {{ parent() }}

    {% if app.user and is_granted('ROLE_VENDEUR_OCCASION') %}
        <div class="container my-5 px-4 px-md-5">
            <h3 class="mb-5 text-center fw-bold text-primary">
                Proposer une offre pour la demande {{ demande.code }}
            </h3>

            <form id="formOffre" method="POST" action="{{ path('ajouter_off_occ', {'id': demande.id}) }}">
                {% for piece in demande.pieces %}
                    <div class="card mb-5 shadow-lg border-0 rounded-4 p-4" 
                         style="background: linear-gradient(135deg, #28a745 0%, #85e085 100%); color: #fff;">
                        <h4 class="fw-bold mb-4">{{ piece.designation }}</h4>

                        {# --- PRIX --- #}
                        <div class="row g-3 mb-2">
                            {% for i in 1..3 %}
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">PRIX UNITAIRE TTC {{ i }}ère Qualité</label>
                                    <input type="text" 
                                           name="pieces[{{ piece.id }}][prix{{ i }}]" 
                                           class="form-control rounded-3" 
                                           placeholder="Prix {{ i }}">
                                </div>
                            {% endfor %}
                        </div>

                        {# --- MARQUE --- #}
                        <div class="row g-3 mb-3">
                            {% for i in 1..3 %}
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">MARQUE {{ i }}ère Qualité</label>
                                    <input type="text" 
                                           name="pieces[{{ piece.id }}][marque{{ i }}]" 
                                           class="form-control rounded-3" 
                                           placeholder="Marque {{ i }}">
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}

                {# --- OBSERVATION + VALIDITÉ --- #}
                <div class="row g-3 mb-4">
                    <div class="col-md-8">
                        <label class="form-label fw-bold text-dark mb-2">Observation générale</label>
                        <textarea name="observation" placeholder="Saisissez vos remarques..." 
                                  class="form-control rounded-4 shadow-sm p-3" 
                                  style="background-color: #f0f2f5; border: 1px solid #ddd; height:120px;"></textarea>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-bold text-dark mb-2">Validité de l'offre</label>
                        <input type="text" name="validite" id="validite" 
                               class="form-control rounded-4 shadow-sm p-3" 
                               style="background-color: #f0f2f5; border: 1px solid #ddd;" 
                               placeholder="Choisir la date de validité">

                        <div class="d-grid p-3 mt-3">
                            <button type="submit" class="btn btn-primary btn-lg rounded-pill shadow-sm" 
                                    style="background: linear-gradient(135deg, #28a745 0%, #85e085 100%); border:none; font-weight:600;">
                                <i class="fas fa-paper-plane me-2"></i> Envoyer l'offre
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    {% endif %}
{% endblock %}

{% block javascript %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // Focus styling
            document.querySelectorAll('.form-control').forEach(el => {
                el.addEventListener('focus', () => {
                    el.style.borderColor = '#6a11cb';
                    el.style.boxShadow = '0 0 8px rgba(106,17,203,0.2)';
                });
                el.addEventListener('blur', () => {
                    el.style.borderColor = '#ddd';
                    el.style.boxShadow = 'none';
                });
            });

            // Initialisation du daterangepicker
          $('#validite').daterangepicker({
    autoUpdateInput: true,
    locale: {
        format: 'DD/MM/YYYY',
        applyLabel: 'Appliquer',
        cancelLabel: 'Annuler',
        daysOfWeek: ['Di', 'Lu', 'Ma', 'Me', 'Je', 'Ve', 'Sa'],
        monthNames: [
            'Janvier','Février','Mars','Avril','Mai','Juin',
            'Juillet','Août','Septembre','Octobre','Novembre','Décembre'
        ],
        firstDay: 1
    },
    opens: 'right',
    startDate: moment(),               // date de début par défaut
    endDate: moment().add(7, 'days')   // date de fin par défaut
});

            // Validation du formulaire avant envoi
    const form = document.getElementById('formOffre');
    if (form) {
        form.addEventListener('submit', function(e) {
            let formulaireValide = true; // global
            const pieces = document.querySelectorAll('[name^="pieces["]');

            // On récupère toutes les pièces par ID unique
            let pieceIds = new Set();
            pieces.forEach(input => {
                const match = input.name.match(/pieces\[(\d+)\]/);
                if (match) pieceIds.add(match[1]);
            });

            // Pour chaque pièce, on vérifie les 3 combinaisons
            pieceIds.forEach(pieceId => {
                let combinaisonValide = false;

                for (let i = 1; i <= 3; i++) {
                    let prix = document.querySelector(`input[name="pieces[${pieceId}][prix${i}]"]`);
                    let marque = document.querySelector(`input[name="pieces[${pieceId}][marque${i}]"]`);

                    if (prix && marque && prix.value.trim() !== '' && marque.value.trim() !== '') {
                        combinaisonValide = true;
                        break;
                    }
                }

                if (!combinaisonValide) {
                    formulaireValide = false;

                    // Ajoute un effet visuel sur la carte correspondante
                    const card = document.querySelector(`input[name="pieces[${pieceId}][prix1]"]`)
                        ?.closest('.card');
                    if (card) {
                        card.style.boxShadow = '0 0 10px 2px rgba(255,0,0,0.6)';
                        setTimeout(() => card.style.boxShadow = '', 2000);
                    }
                }
            });

            if (!formulaireValide) {
                e.preventDefault();
                if (window.AIZ && AIZ.plugins && AIZ.plugins.notify) {
                    AIZ.plugins.notify('danger', 'Chaque pièce doit avoir au moins une combinaison (prix + marque) remplie.');
                } else {
                    alert('Chaque pièce doit avoir au moins une combinaison (prix + marque) remplie.');
                }
            }
        });
    }
});
    </script>
{% endblock %}
