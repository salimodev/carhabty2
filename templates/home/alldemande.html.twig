{% extends 'layout.html.twig' %}

{% block title %}Carhabty
{% endblock %}

{% block LinksCss %}
	{{ parent() }}
	<link rel="stylesheet" href="{{ asset ('css/stylebutton.css') }}">
	<style>
		.request-card {
			background: linear-gradient(135deg, #ffffff, #f7f8fc);
			border-radius: 15px;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
			padding: 15px;
			transition: all 0.3s ease;
		}

		.request-card:hover {
			transform: translateY(-4px);
			box-shadow: 0 8px 20px rgba(255, 107, 53, 0.3);
		}

		.request-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 10px;
		}

		.request-title {
			font-weight: 700;
			font-size: 16px;
			color: #222;
			line-height: 1.3;
			flex: 1;
		}

		.request-badge {
			background: linear-gradient(135deg, #ff6b35 0%, #fca311 50%, #2ec4b6 100%);
			color: #fff;
			font-size: 12px;
			border-radius: 12px;
			padding: 5px 12px;
			font-weight: 700;
			letter-spacing: 0.5px;
			text-transform: uppercase;
			box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
			display: inline-block;
			transition: all 0.3s ease;
		}

		.request-badge:hover {
			transform: scale(1.05);
			box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
		}
		.request-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 8px;
		}


		.request-meta {
			font-size: 13px;
			color: #666;
			display: flex;
			justify-content: space-between;
			flex-wrap: wrap;
			gap: 4px;
			margin-bottom: 10px;
		}

		.request-image img {
			width: 100%;
			height: 220px;
			object-fit: cover;
			border-radius: 10px;
			margin-bottom: 10px;
		}

		.request-description {
			font-size: 14px;
			color: #333;
			line-height: 1.4;
			min-height: 50px;
			margin-bottom: 10px;
		}

		.request-meta {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
			color: #555;
			font-size: 14px;
			align-items: center;
			margin-bottom: 10px;
		}

		.request-meta i {
			color: #ff6b35;
			margin-right: 5px;
			font-size: 15px;
		}

		.btn-register i {
			margin-right: 8px;
			font-size: 16px;
			color: #fff;
		}
		.btn-register {
			background: linear-gradient(45deg, #ff6b35, #ff8c00);
			border: none;
			color: white;
			font-weight: 600;
			transition: 0.3s ease;
		}
		.btn-register:hover {
			background: linear-gradient(45deg, #ff8c00, #ff6b35);
			transform: translateY(-2px);
		}
		/* Effet au survol */
		.btn-register:hover {
			background: linear-gradient(45deg, #ff8c00, #ff6b35);
			transform: translateY(-2px);
			box-shadow: 0 4px 10px rgba(255, 107, 53, 0.4);
		}

		/* Animation de l'enveloppe quand la carte est survol√©e */
		.request-card:hover .btn-register i {
			animation: vibrate 0.3s linear infinite;
		}

		@keyframes vibrate {
			0% {
				transform: rotate(0deg);
			}
			25% {
				transform: rotate(10deg);
			}
			50% {
				transform: rotate(-10deg);
			}
			75% {
				transform: rotate(10deg);
			}
			100% {
				transform: rotate(0deg);
			}
		}
		/* üì± Responsive fixes */
		@media(max-width: 768px) {
			.request-card {
				padding: 12px;
				min-height: auto;
			}
			.request-title {
				font-size: 15px;
			}
			.request-meta {
				font-size: 12px;
			}
			.request-image img {
				height: 180px;
			}
		}


		.btn-propdemande {
			background: linear-gradient(45deg, #ff6b35, #ff9f1c);
			background: linear-gradient(45deg, #2ec4b6, #ff9f1c);
			color: white;
			box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
		}


		.btn-offer {
			background-color: #ff4d00;
			color: white;
			border: none;
			width: 100%;
			padding: 10px;
			border-radius: 10px;
			font-weight: 600;
			cursor: pointer;
			transition: background 0.2s ease;
		}
		.btn-offer:hover {
			background-color: #e64300;
		}

		.badge-custom {
			display: inline-block;
			padding: 3px;
			font-size: 11px;
			border-radius: 0 50em 50em 0;
			color: #ffffff;
			font-weight: 600;
			line-height: 23px;
			position: absolute;
			background: linear-gradient(45deg, #ff6b35, #ff9f1c);
			z-index: 1;
			top: 20px;
			box-shadow: 2px 1px 6px 2px rgb(0 0 0 / 10%), 0 4px 4px 0 rgb(0 0 0 / 15%) !important;
		}
		.badge-custom .box {
			height: 26px;
			width: 26px;
			background: linear-gradient(45deg, #ff6b35, #ff9f1c);
			color: #fff;
			display: inline-block;
			border-radius: 50%;
			text-align: center;
		}

        /* Container centr√© */
.aiz-pagination {
  display: flex;
  justify-content: center;
  margin-top: 1rem;
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}

/* Style g√©n√©rique pour l'√©l√©ment pagination (KNP peut g√©n√©rer <ul class="pagination"> ou <div>) */
.aiz-pagination .pagination,
.aiz-pagination ul.pagination {
  display: flex;
  gap: 0.5rem;
  list-style: none;
  padding: 0;
  margin: 0;
  align-items: center;
}

/* Liens / boutons */
.aiz-pagination a,
.aiz-pagination .page-link,
.aiz-pagination li a {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 40px;
  height: 40px;
  padding: 0 12px;
  border-radius: 8px;
  text-decoration: none;
  color: #333;
  background: #fff;
  border: 1px solid rgba(34,41,47,0.08);
  box-shadow: 0 1px 2px rgba(34,41,47,0.03);
  transition: transform .06s ease, box-shadow .06s ease, background .12s;
  font-weight: 600;
}

/* Hover */
.aiz-pagination a:hover,
.aiz-pagination .page-link:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(34,41,47,0.08);
  background: #ffffff;
  color: #111827;
}

/* Bouton actif */
.aiz-pagination .active,
.aiz-pagination .page-link.active,
.aiz-pagination li.active a {
  background: linear-gradient(90deg,#ff7a00,#ff4d00); /* orange d√©grad√© */
  color: #fff;
  border: none;
  box-shadow: 0 8px 24px rgba(255,77,0,0.12);
  transform: none;
}

/* Disabled */
.aiz-pagination .disabled,
.aiz-pagination .page-link.disabled,
.aiz-pagination li.disabled a {
  opacity: 0.45;
  pointer-events: none;
  background: #f8fafc;
  color: #6b7280;
  border: 1px solid rgba(34,41,47,0.03);
}

/* Prev / Next petites fl√®ches */
.aiz-pagination .prev,
.aiz-pagination .next {
  min-width: 36px;
  padding: 0 10px;
  border-radius: 6px;
}

/* Responsive : r√©duire les boutons sur petits √©crans */
@media (max-width: 576px) {
  .aiz-pagination a,
  .aiz-pagination .page-link {
    min-width: 34px;
    height: 34px;
    padding: 0 8px;
    border-radius: 6px;
    font-size: 14px;
  }

  .aiz-pagination .pagination { gap: 0.35rem; }
}

	</style>
{% endblock %}

{% block Content %}
{% block loader %}
		{{ parent() }}
	{% endblock %}
<section class="mb-4 pt-3">
	<div class="container sm-px-0">
		<form class="" id="search-form" action="" method="GET">
			<div class="row">

				<div class="col-xl-12">


					<div class="text-left">
						<div class="row gutters-5 flex-wrap align-items-center">
							<div class="col col-10">
								<h1 class="h6 fw-600 text-body">
									Demandes
								</h1>
							</div>
							<div
								class="row justify-content-end align-items-end g-2 mb-4 filtre-demandes">

								<!-- Filtre Marque -->
								<div class="col-6 col-md-auto">
									<label class="mb-0 opacity-50 small">Marque</label>
									<select class="form-control form-control-sm" onchange="filtrerDemandes()" id="marque" data-live-search="true">
										<option value="">Toutes les marques</option>
										<option value="Audi">Audi</option>
										<option value="BMW">BMW</option>
										<option value="Mercedes">Mercedes</option>
										<option value="Toyota">Toyota</option>
									</select>
								</div>

								<!-- Filtre Zone -->
								<div class="col-6 col-md-auto">
									<label class="mb-0 opacity-50 small">Zone</label>
									<select class="form-control form-control-sm" onchange="filtrerDemandes()" id="zone" data-live-search="true">
										<option value="">Toute la Tunisie</option>
										<option value="Tunis">Tunis</option>
										<option value="Ariana">Ariana</option>
										<option value="Ben Arous">Ben Arous</option>
										<option value="Manouba">Manouba</option>
										<option value="Nabeul">Nabeul</option>
										<option value="Zaghouan">Zaghouan</option>
										<option value="Bizerte">Bizerte</option>
										<option value="B√©ja">B√©ja</option>
										<option value="Jendouba">Jendouba</option>
										<option value="Kef">Kef</option>
										<option value="Siliana">Siliana</option>
										<option value="Sousse">Sousse</option>
										<option value="K√©bili">Sfax</option>
										<option value="Monastir">Monastir</option>
										<option value="Mahdia">Mahdia</option>
										<option value="Kairouan">Kairouan</option>
										<option value="Kasserine">Kasserine</option>
										<option value="Sidi Bouzid">Sidi Bouzid</option>
										<option value="Gab√®s">Gab√®s</option>
										<option value="M√©denine">M√©denine</option>
										<option value="Tataouine">Tataouine</option>
										<option value="Gafsa">Gafsa</option>
										<option value="Tozeur">Tozeur</option>
										<option value="K√©bili">K√©bili</option>

									</select>
								</div>

								<!-- Filtre Date -->
								<div class="col-6 col-md-auto">
									<label class="mb-0 opacity-50 small">Date</label>
									<select class="form-control form-control-sm" onchange="filtrerDemandes()" id="date">
										<option value="recent">Le plus r√©cent</option>
										<option value="ancien">Le plus ancien</option>
									</select>
								</div>

								<!-- Filtre Type -->
								<div class="col-6 col-md-auto">
									<label class="mb-0 opacity-50 small">Type</label>
									<select class="form-control form-control-sm" onchange="filtrerDemandes()" id="type">
										<option value="">Tous</option>
										<option value="neuf">Neuf</option>
										<option value="occasion">Occasion</option>
									</select>
								</div>

							</div>


						</div>
					</div>
					<input type="hidden" name="min_price" value="">
					<input type="hidden" name="max_price" value="">
					<div class="row gutters-5 row-cols-xxl-3 row-cols-xl-3 row-cols-lg-3 row-cols-md-2 row-cols-1" id="filterrech">
			{% for demande in lastDemandes %}
    {% set dejaPropose = app.user ? (demande.offres|filter(o => o.user.id == app.user.id)|length > 0) : false %}
    {% set estVendeur = app.user and 'ROLE_VENDEUR' in app.user.roles %}

    <div class="col mb-3">
        <div class="carousel-box">
            <div class="request-card">

                <div class="request-header">
                    <a href="{{ path('detail_demande_accuill', {'id': demande.id}) }}" class="text-decoration-none text-dark">
                        <div class="request-title">
                            {% if demande.pieces|length > 0 %}
                                {% for piece in demande.pieces %}
                                    {{ demande.marque }} {{ piece.designation }}{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            {% else %}
                                {{ demande.marque }} {{ demande.modele }}
                            {% endif %}
                        </div>
                    </a>
                    <div class="request-badge">
                        {% if demande.vendeuroccasion == 1 %}
                            Occasion
                        {% else %}
                            Neuf
                        {% endif %}
                    </div>
                </div>

                <div class="request-meta">
                    <span><i class="fas fa-map-marker-alt"></i> {{ demande.zone }}</span>
                    <span><i class="fas fa-user"></i> {{ demande.offrecompte ? demande.offrecompte.nom : 'Anonyme' }}</span>
                    <span><i class="far fa-clock"></i> {{ demande.datecreate|time_ago }}</span>
                </div>

                <a href="{{ path('detail_demande_accuill', {'id': demande.id}) }}" class="text-decoration-none">
                    <div class="request-image">
                        {% set photo = (demande.pieces|first).photo ?? '/assets/img/placeholder.png' %}
                        <img src="{{ photo }}" alt="photo" class="img-fit mx-auto rounded">
                    </div>
                </a>

                <p class="request-description">
                    {% if demande.pieces|length > 0 %}
                        {% for piece in demande.pieces|slice(0,3) %}
                            {{ piece.observation }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                        {% if demande.pieces|length > 3 %}...{% endif %}
                    {% else %}
                        Pas de description disponible.
                    {% endif %}
                </p>

                <a href="{% if estVendeur and not dejaPropose %}{{ path('propose_offre', {'id': demande.id}) }}{% else %}#{% endif %}" 
                   class="btn btn-register btn-circle w-100 text-center"
                   {% if not app.user %}
                       onclick="AIZ.plugins.notify('danger', 'Veuillez vous connecter pour proposer une offre !'); return false;"
                   {% elseif not estVendeur %}
                       onclick="AIZ.plugins.notify('danger', 'Seuls les vendeurs peuvent proposer une offre !'); return false;"
                   {% elseif dejaPropose %}
                       onclick="AIZ.plugins.notify('danger', 'Vous avez d√©j√† propos√© une offre pour cette demande !'); return false;"
                   {% endif %}>
                    <i class="fas fa-envelope-open-text me-2"></i>
                    Proposer un prix
                </a>

            </div>
        </div>
    </div>
{% endfor %}

					</div>
				</div>
			</div>
			<div class="aiz-pagination aiz-pagination-center mt-4">
				{{ knp_pagination_render(lastDemandes) }}
			</div>

		</form>
	</div>
</section>

{% endblock %}
{% block javascript %}
	{{ parent() }}
	<script>

    function timeAgo(dateString) {
    var now = new Date();
    var past = new Date(dateString);
    var diff = Math.floor((now - past) / 1000); // en secondes

    if (diff < 60) return '√† l\'instant';
    if (diff < 3600) return Math.floor(diff / 60) + ' minute(s) ago';
    if (diff < 86400) return Math.floor(diff / 3600) + ' heure(s) ago';
    if (diff < 2592000) return Math.floor(diff / 86400) + ' jour(s) ago';
    return past.toLocaleDateString(); // ou "d/m/Y" selon besoin
}
function filtrerDemandes() {
    var url = "{{ path('recherche_demande') }}";

    var marque = $('#marque').val();
    var zone = $('#zone').val();
    var date = $('#date').val();
    var type = $('#type').val();
    var trier = $('#trier').val();

    var data = {
        marque: marque,
        zone: zone,
        date: date,
        type: type,
        trier: trier
    };

    $.ajax({
        type: "POST",
        url: url,
        data: data,
        success: function(demandes) {
            var html = "";

            if (demandes.length === 0) {
                html = `<div class="text-center p-3" style="margin: auto">
                            <i class="las la-frown la-3x opacity-60 mb-3"></i>
                            <h3 class="h6 fw-700">Aucune demande trouv√©e</h3>
                        </div>`;
            } else {
                demandes.forEach(function(d) {
                    var piecesTitle = "";
                    var piecesDesc  = "";
                    if (d.pieces && d.pieces.length > 0) {
                        piecesTitle = d.pieces.map(p => p.designation).join(", ");
                        piecesDesc  = d.pieces.slice(0,3).map(p => p.observation).join(", ");
                        if (d.pieces.length > 3) piecesDesc += "...";
                    }

                    var dejaPropose = d.dejaPropose || false;
                    var estVendeur  = d.estVendeur || false;
                    var estConnecte = d.estConnecte || false;

                    // üîó Lien vers la page d√©tail
                    var lienDetail = "{{ path('detail_demande_accuill', {'id': 'ID_DEMANDE'}) }}".replace('ID_DEMANDE', d.id);

                    html += `
<div class="col mb-3">
    <div class="carousel-box">
        <div class="request-card">
            <div class="request-header">
                <a href="${lienDetail}" class="text-decoration-none text-dark">
                    <div class="request-title">${piecesTitle || (d.marque + " " + d.modele)}</div>
                </a>
                <div class="request-badge">${d.type === 'occasion' ? 'Occasion' : 'Neuf'}</div>
            </div>
            <div class="request-meta">
                <span><i class="fas fa-map-marker-alt"></i> ${d.zone}</span>
                <span><i class="fas fa-user"></i> ${d.offrecompte}</span>
                <span><i class="far fa-clock"></i> ${timeAgo(d.date)}</span>
            </div>
            <a href="${lienDetail}" class="text-decoration-none">
                <div class="request-image">
                    <img src="${(d.pieces[0] && d.pieces[0].photo) || '/assets/img/placeholder.png'}"
                         alt="photo" class="img-fit mx-auto rounded">
                </div>
            </a>
            <p class="request-description">${piecesDesc || 'Pas de description disponible.'}</p>
            <button class="btn btn-register w-100 propose-btn" 
                    data-id="${d.id}" 
                    data-deja="${dejaPropose}"
                    data-vendeur="${estVendeur}"
                    data-connecte="${estConnecte}">
                <i class="fas fa-envelope-open-text"></i> Proposer un prix
            </button>
        </div>
    </div>
</div>`;
                });
            }

            $('#filterrech').html(html);

            // Intercepter clics du bouton "Proposer un prix"
            $('#filterrech').find('.propose-btn').each(function() {
                $(this).on('click', function(e) {
                    e.preventDefault();

                    let deja = $(this).data('deja');
                    let estVendeur = $(this).data('vendeur');
                    let estConnecte = $(this).data('connecte');
                    let demandeId = $(this).data('id');

                    if (!estConnecte) {
                        AIZ.plugins.notify('danger', 'Veuillez vous connecter pour proposer une offre !');
                        return;
                    }

                    if (!estVendeur) {
                        AIZ.plugins.notify('danger', 'Seuls les vendeurs peuvent proposer une offre !');
                        return;
                    }

                    if (deja) {
                        AIZ.plugins.notify('danger', 'Vous avez d√©j√† propos√© une offre pour cette demande !');
                        return;
                    }

                    let url = "{{ path('propose_offre', {'id': 'ID_DEMANDE'}) }}".replace('ID_DEMANDE', demandeId);
                    window.location.href = url;
                });
            });
        },
        beforeSend: function(){ $('#loaderAcc1').show(); },
        complete: function(){ $('#loaderAcc1').hide(); }
    });
}

	</script>

{% endblock %}

