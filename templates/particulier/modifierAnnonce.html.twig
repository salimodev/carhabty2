{% extends 'layout.html.twig' %}

{% block title %}
Essayara
{% endblock %}

{% block Head %}
{{ parent() }}
{% block LinksCss %}
{{ parent() }} <link rel="stylesheet" href="{{ asset('css/stylebutton.css') }}">
{% endblock %}
{% endblock %}

{% block Content %}
{% block loader %}
{{ parent() }}
{% endblock %}

{% if app.user %}
{% if is_granted('ROLE_PARTICULIER') %}

<section class="py-5" style="background-color:#f5f5f5;">
    <div class="container">
        <div class="d-flex align-items-start">

        {% block sideHeader %}
            {{ parent() }}
        {% endblock %}

        <div class="col-lg-9 px-3">
            <div class="aiz-titlebar text-left mt-2 mb-3">
                <h5 class="mb-0 h6">Modifier l’annonce</h5>
            </div>

            <form class="form-horizontal" enctype="multipart/form-data" id="product_form" method="POST">
                <div class="row g-3">

                    <!-- CARD 1 -->
                    <div class="col-12 col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0 h6">Informations sur la pièce</h5>
                            </div>
                            <div class="card-body">

                                <div class="form-group">
                                    <label>Nom <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="nom" value="{{ annonce.nom }}" required>
                                </div>

                                <div class="form-group">
                                    <label>Référence</label>
                                    <input type="text" class="form-control" id="reference" value="{{ annonce.reference }}">
                                </div>

                                <div class="form-group">
                                    <label>Marque <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="marque" value="{{ annonce.marque }}" required>
                                </div>

                                <div class="form-group">
                                    <label>Modèle <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="modele" value="{{ annonce.modele }}" required>
                                </div>

                                <div class="form-group">
                                    <label>Prix <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="prix" min="0" value="{{ annonce.prix }}" required>
                                </div>

                                <div class="form-group">
                                    <label>Description</label>
                                    <textarea class="form-control" id="description" rows="4">{{ annonce.description }}</textarea>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- CARD 2 -->
                    <div class="col-12 col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0 h6">Images du produit</h5>
                            </div>
                            <div class="card-body">

                                <!-- Image principale -->
                                <div class="form-group row">
                                    <label class="col-md-3 col-form-label">
                                        Image principale <span class="text-danger">*</span>
                                        <small>(120x80)</small>
                                    </label>

                                    <div class="col-md-8">
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <div class="input-group-text bg-soft-secondary font-weight-medium" 
                                                     style="cursor:pointer;" onclick="cloudDinaryimageProd()">
                                                     Parcourir
                                                </div>
                                            </div>

                                            <div class="form-control file-amount" onclick="cloudDinaryimageProd()">
                                                1 fichier sélectionné
                                            </div>

                                            <input type="hidden" id="srcLogo2" value="{{ annonce.imagePrincipale }}">
                                        </div>

                                        <div class="file-preview box sm" id="NewPhotos2" style="display:block;">
                                            <div class="d-flex justify-content-between align-items-center mt-2 file-preview-item">
                                                <div class="align-items-center d-flex justify-content-center thumb">
                                                    <img src="{{ annonce.imagePrincipale }}" id="logoImg2" class="img-fit">
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>

                                <!-- Galerie -->
                                <div class="form-group row">
                                    <label class="col-md-3 col-form-label">
                                        Images Galerie
                                        <small>(600x600)</small>
                                    </label>

                                    <div class="col-md-8">
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <div class="input-group-text bg-soft-secondary font-weight-medium"
                                                     onclick="cloudDinaryBanner()" style="cursor:pointer;">
                                                     Parcourir
                                                </div>
                                            </div>

                                            <div class="form-control file-amount" onclick="cloudDinaryBanner()">
                                                maximum 5 images
                                            </div>

                                            <input type="hidden" id="srcLogo" value="">
                                        </div>

                                        <br>

                                        <div class="file-preview box sm" id="NewPhotos" style="display:block;">
                                            {% for photo in annonce.images %}
                                                <img src="{{ photo.path }}" style="width:85px;height:85px;margin-right:4px;">
                                            {% endfor %}
                                        </div>

                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- BUTTON -->
                    <div class="text-end mt-3">
                        <button type="button" onclick="modifierAnnonce({{ annonce.id }})" class="btn btn-register">
                            Modifier l'annonce
                        </button>
                    </div>

                </div>
            </form>

        </div>
    </div>
</div>

</section>

{% endif %}
{% endif %}
{% endblock %}

{% block javascript %}
{{ parent() }}

<script>



cloudinary.setCloudName('b-ja');
function cloudDinaryimageProd() {
     $('#cloudinaryPreloader').show();
    cloudinary.openUploadWidget({
        api_key: '539474279193439',
        api_secret: '7A1irSbuKcg2XIH1TLqB4pBUZfA',
        cloud_name: 'aladdineshoping',
        upload_preset: 'aladdineshop',
        folder: 'ml_default',

        theme: 'minimal',
        max_file_size: 300000000,

        image_metadata: true,
        client_allowed_formats: ["png", "jpeg", "webp", "gif", "svg"],
        resource_type: 'image',
        folder: 'folder',
        cropping: 'server',
        cropping_coordinates_mode: 'custom',
        cropping_aspect_ratio: 0.72,
        sources: ['local', 'url'],
        button_caption: 'Télécherger image',
       
       
    },
           


              (error, result) => { 
                 $('#cloudinaryPreloader').hide();
    if (!error && result && result.event === "success") { 
                $type = "photo";
                $("#srcLogo2").val(result.info.secure_url);



                $('#logoImg2').attr('src', result.info.secure_url);
				$('#NewPhotos2').css('display', 'block');
                $('#logoImg2').css('display', 'block');

      console.log('Done! Here is the image info: ', result.info.secure_url); 
    }
  }
            );



}

$cloudImages = [];
cloudinary.setCloudName('b-ja');

function cloudDinaryBanner() {
     $('#cloudinaryPreloader').show();
   cloudinary.openUploadWidget({
        api_key: '539474279193439',
        api_secret: '7A1irSbuKcg2XIH1TLqB4pBUZfA',
        cloud_name: 'b-ja',
        upload_preset: 'aladdineshop',
        folder: 'aladsine',

        html: { multiple: 5 },
        theme: 'minimal',
          // max_file_size: 300000000,

          // image_metadata:true,
        client_allowed_formats: ["png", "jpeg", "webp", "gif", "svg"],
        resource_type: 'image',
          // folder: 'icones',
          // cropping: 'server',
          // cropping_coordinates_mode: 'custom',
        cropping_aspect_ratio: 0.72,
        sources: ['local', 'url'],
        button_caption: 'Télécherger image',
        
                                        },
                                                function (error, result){
                                                     $('#cloudinaryPreloader').hide();
                                                if (!error && result && result.event === "queues-end") { 
                                                   console.log(error,result.info.files[0].uploadInfo.secure_url);
                                                   $('#pathPhoto').val(result.info.files[0].uploadInfo.secure_url);
                                                   for (i=0;i<result.info.files.length;i++){
                                                        var img =document.createElement("img");

                                                       img.id="img"+i;

                                                       img.src=result.info.files[i].uploadInfo.secure_url;
                                                       img.style.width="85px";
                                                       img.style.height="85px";
                                                       img.style.marginRight="4px";
                                                       img.style.marginBottom="19px";
                                                      // img.style.marginBottom="15px";

                                                        $('#NewPhotos').append(img);
                                                      //  $('#NewPhotos').append(' <div class="d-flex justify-content-between align-items-center mt-2 file-preview-item" data-id="99" title="1626638583730.jpg"><div class="align-items-center align-self-stretch d-flex justify-content-center thumb"><img src="" id="logoImg1" class="img-fit"></div><div class="col body"><h6 class="d-flex"><span class="text-truncate title">1626638583730</span><span class="ext">.jpg</span></h6><p>2 KB</p></div><div class="remove"><button class="btn btn-sm btn-link remove-attachment" type="button"><i class="la la-close"></i></button></div></div>')
                                                     //   $('#NewPhotos').append(' <div class="d-flex justify-content-between align-items-center mt-2 file-preview-item" data-id="99" title="1626638583730.jpg"><div class="align-items-center align-self-stretch d-flex justify-content-center thumb"><img src="" id="logoImg2" class="img-fit"></div><div class="col body"><h6 class="d-flex"><span class="text-truncate title">1626638583730</span><span class="ext">.jpg</span></h6><p>2 KB</p></div><div class="remove"><button class="btn btn-sm btn-link remove-attachment" type="button"><i class="la la-close"></i></button></div></div>')
                                                     
                                                       $cloudImages.push({'path': result.info.files[i].uploadInfo.secure_url});

                                                       $type = "photo";
             //   $("#srcLogo").val(result[0].secure_url);



             //   $('#logoImg').attr('src', result[0].secure_url);
            //    $('#logoImg1').attr('src', result[1].secure_url);
              //  $('#logoImg2').attr('src', result[2].secure_url);
				$('#NewPhotos').css('display', 'block');
               // $('#logoImg').css('display', 'block');





              //  console.log(error, result.info.files[0].uploadInfo.secure_url);
                                                     //   console.log($cloudImages);
                                                   }
                                                }
                                                });



                                        }



function modifierAnnonce(id) {
    let nom = $('#nom').val().trim();
    let marque = $('#marque').val().trim();
    let modele = $('#modele').val().trim();
    let prix = $('#prix').val().trim();
    let banner = $('#srcLogo2').val().trim();

    if (!nom) {
        Swal.fire({ icon: "warning", title: "Champ manquant", text: "Veuillez remplir le champ Nom !" });
        return;
    }
    if (!marque) {
        Swal.fire({ icon: "warning", title: "Champ manquant", text: "Veuillez remplir le champ Marque !" });
        return;
    }
    if (!modele) {
        Swal.fire({ icon: "warning", title: "Champ manquant", text: "Veuillez remplir le champ Modèle !" });
        return;
    }
    if (!prix) {
        Swal.fire({ icon: "warning", title: "Champ manquant", text: "Veuillez remplir le champ Prix !" });
        return;
    }
    if (!banner) {
        Swal.fire({ icon: "warning", title: "Image manquante", text: "Veuillez ajouter une image principale !" });
        return;
    }

    // Tous les champs obligatoires remplis
    let data = {
        nom: nom,
        marque: marque,
        modele: modele,
        reference: $('#reference').val().trim(),
        prix: prix,
        description: $('#description').val().trim(),
        banner: banner,
        cloudImages: JSON.stringify($cloudImages)
    };

    $.ajax({
        type: "POST",
        url: "{{ path('modifier_annonce_ajax', {'id': annonce.id}) }}",
        data: data,
        success: function () {
            Swal.fire({
                icon: "success",
                title: "Succès",
                text: "Annonce modifiée avec succès !"
            });
            location.reload();
        }
    });
}




</script>

{% endblock %}
