{% extends 'layoutAdmin.html.twig' %}
{% block Head %}
    {{ parent() }}
    {% block LinksCss %}
        {{ parent() }}
        <link rel="stylesheet" href="{{ asset('css/style-detail-cos.css') }}">
        <style>
        /* --- Styles cartes statistiques --- */
        .stat-card {
            display: flex;
            align-items: center;
            padding: 20px;
            border-radius: 12px;
            color: #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            min-height: 120px;
            height:90%;
            margin-bottom: 2%;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        .stat-card .icon-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            background: rgba(255,255,255,0.2);
            margin-right: 15px;
        }
        .stat-card .stat-text .title {
            font-size: 24px;
            font-weight: 700;
        }
        .stat-card .stat-text .subtitle {
            font-size: 14px;
            opacity: 0.85;
        }

        /* Couleurs sp√©cifiques */
        .bg-primary { background: linear-gradient(135deg,#6c5ce7,#a29bfe); }
        .bg-success { background: linear-gradient(135deg,#00b894,#55efc4); }
        .bg-warning {background: linear-gradient(135deg, #f4a300  0%, #fbd15eff  );}
        .bg-info {background: linear-gradient(135deg, #138496, #17a2b8, #71d4e0);
}
        /* --- Card info utilisateur --- */
        .card-user {
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            min-height: 120px;
        }
        .card-user .avatar-img {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        }
        .card-user .card-title {
            font-size: 20px;
            font-weight: 700;
        }
        .card-user p {
            margin: 2px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        </style>
    {% endblock %}
{% endblock %}

{% block title %}M√©canicien{% endblock %}
{% block loader %}{{ parent() }}{% endblock %}
{% block sidebar %}{{ parent() }}{% endblock %}

{% block page %}
{{ parent() }}
<section class="py-5">
    <div class="container">
         <!-- STATISTIQUES + INFO MECANICIEN -->
       <div class="row mb-3 g-3">

    <div class="col-lg-12 d-flex align-items-stretch">
        <div class="row g-3 flex-fill">

            <!-- Total demandes -->
            <div class="col-md-3">
                <div class="stat-card bg-primary">
                    <div class="icon-circle">
                        <i class="las la-list-alt"></i>
                    </div>
                    <div class="stat-text">
                        <div class="title">{{ totalDemandes }}</div>
                        <div class="subtitle">Total demandes</div>
                    </div>
                </div>
            </div>

            <!-- Demandes en attente -->
            <div class="col-md-3">
                <div class="stat-card bg-warning">
                    <div class="icon-circle">
                        <i class="las la-hourglass-half"></i>
                    </div>
                    <div class="stat-text">
                        <div class="title">{{ totalEnAttente }}</div>
                        <div class="subtitle">En attente</div>
                    </div>
                </div>
            </div>

            <!-- Demandes publi√©es -->
            <div class="col-md-3">
                <div class="stat-card bg-info">
                    <div class="icon-circle">
                        <i class="las la-check-circle"></i>
                    </div>
                    <div class="stat-text">
                        <div class="title">{{ totalPublie }}</div>
                        <div class="subtitle">Publi√©</div>
                    </div>
                </div>
            </div>

            <!-- Demandes servues -->
            <div class="col-md-3">
                <div class="stat-card bg-success">
                    <div class="icon-circle">
                        <i class="las la-concierge-bell"></i>
                    </div>
                    <div class="stat-text">
                        <div class="title">{{ totalServue }}</div>
                        <div class="subtitle">Servue</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

</div>


        <!-- TABLEAUX DEMANDES & OFFRES -->
        <div class="row g-3">
            <div class="col-12">
                <!-- TABLEAU DES DEMANDES -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0 h6">Toutes les demandes</h5>
                    </div>
                    <div class="card-body">
                        <table id="mechantab" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Marque</th>
                                    <th>Mod√®le</th>
                                    <th>N¬∞ Ch√¢ssis</th>
                                    <th>√ânergie</th>
                                    <th>√âtat moteur</th>
                                    <th>Date</th>
                                    <th>publi√©</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for demande in demandes %}
                                <tr>
                                    <td><a href="{{ path('detail_demande_admin', {'id': demande.id}) }}">{{ demande.code }}</a></td>
                                    <td>{{ demande.marque }}</td>
                                    <td>{{ demande.modele }}</td>
                                    <td>{{ demande.chassis }}</td>
                                    <td>{{ demande.energie }}</td>
                                    <td>{{ demande.etatmoteur }}</td>
                                    <td>{{ demande.datecreate|date('d/m/Y H:i') }}</td>
                                   <td>
                                   {% if demande.statut != 'fermer' %}
    <label class="aiz-switch aiz-switch-success mb-0">
        <input onchange="updateDemandePublier(this)" 
               value="{{ demande.id }}" 
               type="checkbox" 
               id="Publier" 
               name="Publier"
               {% if demande.publier == 1 %} checked {% endif %}>
        <span class="slider round"></span>
    </label>
     {% endif %}
</td>
                                    <td>
                                        {% if demande.statut == 'en_attente' %}
                                            <span class="badge badge-inline badge-warning">en attente</span>
                                             {% elseif demande.statut == 'publi√©' %}
                                              <span class="badge badge-inline badge-primary ">publi√©</span>
                                        {% elseif demande.statut == 'fermer' %}
                                            <span class="badge badge-inline badge-success">Servue</span>
                                        {% endif %}
                                    </td>
                                    
                                    <td class="text-right">
                             {% if demande.statut == 'fermer' or demande.statut == 'publi√©' %}
    <a href="javascript:void(0);"
       onclick="toggleServue({{ demande.id }})"
       class="btn btn-soft-success btn-icon btn-circle btn-sm"
       title="{{ demande.statut == 'fermer' ? 'Marquer comme non servue' : 'Marquer comme servue' }}"
       id="btn-servue-{{ demande.id }}">
        {% if demande.statut == 'fermer' %}
        <i class="las la-undo-alt"></i>
            {# Servue #}
        {% else %}
            <i class="las la-check-circle"></i>  {# Non servue #}
        {% endif %}
    </a>
{% endif %}


                                        <a class="btn btn-soft-info btn-icon btn-circle btn-sm" href="{{ path('detail_demande_admin', {'id': demande.id}) }}" title="Voir">
                                            <i class="las la-eye"></i>
                                        </a>
                                        <a onclick="supprimerdemande($(this),'{{ demande.id }}');" class="btn btn-soft-danger btn-icon btn-circle btn-sm" title="Supprimer">
                                            <i class="las la-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

            

            </div>
        </div>
    </div>
</section>
{% endblock %}
{% block javascript %}
{{ parent() }}
<script>
$(document).ready(function() {
    $('#mechantab').DataTable({
        language: { "url": 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json' },
        responsive: true
    });
    $('#offrestab').DataTable({
       language: { "url": 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json' },
        responsive: true
    });

});


function supprimerdemande(element, $id) {
     id = parseInt($id);
$_data = {
'id': $id
},
Swal.fire({
title: '√ätes-vous s√ªr de vouloir supprimer cette demande ?',
type: 'warning',
showCancelButton: true,
confirmButtonColor: '#25a89d ',
cancelButtonColor: '#ff6b35',
confirmButtonText: 'Supprimer',
cancelButtonText: 'Annuler'
}).then((result) => {
if (result.value) {
$.ajax({
type: "POST",
url: "{{ path('admin_supprimer_demande') }}",
data: $_data,
success: function (response) {
element.parent().remove();
Swal.fire({title: "success!", text: "la  marque √† √©t√© supprimer avec succ√©s!", icon: "success"});


location.reload();
}
});
}
})
}


function updateDemandePublier(element) {
    let id = element.value;
    let publier = element.checked ? 1 : 0;

    $.ajax({
        type: "POST",
        url: "{{ path('admin_update_publier_demande') }}",
        data: { id: id, publier: publier },
        success: function(response) {
            Swal.fire({
                title: "Succ√®s",
                text: response.message,
                icon: "success"
            }).then(() => {
                location.reload(); // recharge la page pour voir le changement
            });
        },
        error: function() {
            Swal.fire({
                title: "Erreur",
                text: "Une erreur s‚Äôest produite",
                icon: "error"
            });
        }
    });
}


function toggleServue(id) {
    $.ajax({
        type: "POST",
        url: "{{ path('admin_toggle_servue') }}",
        data: { id: id },
        success: function (response) {
            Swal.fire({
                title: "Succ√®s",
                text: response.message,
                icon: "success"
            }).then(() => {
                // üîÑ Recharger la page pour voir les changements
                location.reload();
            });
        },
        error: function () {
            Swal.fire({
                title: "Erreur",
                text: "Une erreur s‚Äôest produite.",
                icon: "error"
            });
        }
    });
}

</script>
{% endblock %}
