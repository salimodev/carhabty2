{% extends 'layoutAdmin.html.twig' %}
{% block Head %}
    {{ parent() }}
    {% block LinksCss %}
        {{ parent() }}
        <link rel="stylesheet" href="{{ asset('css/style-detail-cos.css') }}">
        <style>
        /* --- Styles cartes statistiques --- */
        .stat-card {
            display: flex;
            align-items: center;
            padding: 20px;
            border-radius: 12px;
            color: #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            min-height: 120px;
            height:90%;
            margin-bottom: 2%;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        .stat-card .icon-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            background: rgba(255,255,255,0.2);
            margin-right: 15px;
        }
        .stat-card .stat-text .title {
            font-size: 24px;
            font-weight: 700;
        }
        .stat-card .stat-text .subtitle {
            font-size: 14px;
            opacity: 0.85;
        }

        /* Couleurs spécifiques */
        .bg-primary { background: linear-gradient(135deg,#6c5ce7,#a29bfe); }
        .bg-success { background: linear-gradient(135deg,#00b894,#55efc4); }
        .bg-warning {background: linear-gradient(135deg, #f4a300  0%, #fbd15eff  );}
        .bg-info {background: linear-gradient(135deg, #138496, #17a2b8, #71d4e0);
}
        /* --- Card info utilisateur --- */
        .card-user {
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            min-height: 120px;
        }
        .card-user .avatar-img {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        }
        .card-user .card-title {
            font-size: 20px;
            font-weight: 700;
        }
        .card-user p {
            margin: 2px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        </style>
    {% endblock %}
{% endblock %}

{% block title %}Mécanicien{% endblock %}
{% block loader %}{{ parent() }}{% endblock %}
{% block sidebar %}{{ parent() }}{% endblock %}

{% block page %}
{{ parent() }}
<section class="py-5">
	<div
		class="container">
		<!-- STATISTIQUES + INFO MECANICIEN -->
		<div class="row mb-3 g-3">

			<div class="col-lg-12 d-flex align-items-stretch">
				<div
					class="row g-3 flex-fill">

					<!-- Total offres -->
<div class="col-md-3">
    <div class="stat-card bg-primary">
        <div class="icon-circle">
            <i class="las la-file-invoice-dollar"></i>
        </div>
        <div class="stat-text">
            <div class="title">{{ totalOffres }}</div>
            <div class="subtitle">Total des offres</div>
        </div>
    </div>
</div>

<!-- Offres en attente -->
<div class="col-md-3">
    <div class="stat-card bg-warning">
        <div class="icon-circle">
            <i class="las la-hourglass-half"></i>
        </div>
        <div class="stat-text">
            <div class="title">{{ totalOffresEnAttente }}</div>
            <div class="subtitle">Offres en attente</div>
        </div>
    </div>
</div>

<!-- Offres acceptées -->
<div class="col-md-3">
    <div class="stat-card bg-success">
        <div class="icon-circle">
            <i class="las la-check-double"></i>
        </div>
        <div class="stat-text">
            <div class="title">{{ totalOffresAcceptees }}</div>
            <div class="subtitle">Offres acceptées</div>
        </div>
    </div>
</div>

<!-- Offres refusées -->
<div class="col-md-3">
    <div class="stat-card bg-danger">
        <div class="icon-circle">
            <i class="las la-times-circle"></i>
        </div>
        <div class="stat-text">
            <div class="title">{{ totalOffresRefusees }}</div>
            <div class="subtitle">Offres refusées</div>
        </div>
    </div>
</div>

				</div>
			</div>

		</div>


		<!-- TABLEAUX DEMANDES & OFFRES -->
		<div class="row g-3">
			<div
				class="col-12">
				<!-- TABLEAU DES DEMANDES -->
				  <!-- TABLEAU DES OFFRES REÇUES -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0 h6">Liste des Offres </h5>
                    </div>
                    <div class="card-body">
                        <table id="offrestab" style="width:100%">
                            <thead>
                                <tr>
                                    <th>N° de demande</th>
                                    <th>Date de demande</th>
                                    <th>Marque</th>
                                    <th>Modèle</th>
                                    <th>Offreur</th>
                                    <th>Offre N°</th>
                                    <th>Validité</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if offres is not empty %}
                                    {% for offre in offres %}
                                    <tr>
                                        <td><a href="{{ path('detail_demande_admin', {'id': offre.demande.id}) }}">{{ offre.demande.code }}</a></td>
                                        <td>{{ offre.demande.datecreate|date('d/m/Y') }}</td>
                                        <td>{{ offre.demande.marque }}</td>
                                        <td>{{ offre.demande.modele }}</td>
                                        <td>{{ offre.user.nom ~ ' ' ~ offre.user.prenom }}</td>
                                        <td>{{ offre.numeroOffre }}</td>
                                        <td>
                                            {% if offre.validiteDebut and offre.validiteFin %}
                                                {% set diff = offre.validiteFin.timestamp - offre.validiteDebut.timestamp %}
                                                {% set jours = (diff / 86400)|round(0, 'floor') %}
                                                {{ jours }} jour{{ jours > 1 ? 's' : '' }}
                                            {% else %}
                                                <span class="text-muted">Non définie</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if offre.status == 'acceptee' %}
                                                <span class="badge badge-inline badge-success">Acceptée</span>
                                            {% elseif offre.status == 'refusee' %}
                                                <span class="badge badge-inline badge-danger">Refusée</span>
                                            {% else %}
                                                <span class="badge badge-inline badge-warning text-dark">En attente</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-right">
                                            <a class="btn btn-soft-info btn-icon btn-circle btn-sm" href="{{ path('detail_offre_admin', {'id': offre.id}) }}" title="Voir">
                                                <i class="las la-eye"></i>
                                            </a>
                                            <!-- Accepter -->
    <a href="javascript:void(0);" 
       onclick="toggleOffre({{ offre.id }}, 'accepter')" 
       class="btn btn-soft-success btn-icon btn-circle btn-sm" 
       title="Accepter">
        <i class="las la-check-circle"></i>
    </a>

    <!-- Refuser -->
    <a href="javascript:void(0);" 
       onclick="toggleOffre({{ offre.id }}, 'refuser')" 
       class="btn btn-soft-danger btn-icon btn-circle btn-sm" 
       title="Refuser">
        <i class="las la-times-circle"></i>
    </a>

    <!-- En attente -->
    <a href="javascript:void(0);" 
       onclick="toggleOffre({{ offre.id }}, 'en_attente')" 
       class="btn btn-soft-warning btn-icon btn-circle btn-sm" 
       title="Mettre en attente">
        <i class="las la-hourglass-half"></i>
    </a>

    <!-- Supprimer -->
    <a href="javascript:void(0);" 
       onclick="supprimerOffre($(this),'{{ offre.id }}');" 
       class="btn btn-soft-danger btn-icon btn-circle btn-sm" 
       title="Supprimer">
        <i class="las la-trash"></i>
    </a>
                                          
                                        </td>
                                    </tr>
                                    {% endfor %}

                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>

			</div>
		</div>
	</div>
</section>

{% endblock %}
{% block javascript %}
{{ parent() }}
<script>
$('#offrestab').DataTable({
   language: { "url": 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json' },
   responsive: true
});


function toggleOffre(id, action) {
    $.ajax({
        type: "POST",
        url: "{{ path('admin_toggle_offres') }}",
        data: { id: id, action: action },
        success: function(response) {
            Swal.fire({
                title: "Succès",
                text: response.message,
                icon: "success"
            }).then(() => location.reload());
        },
        error: function() {
            Swal.fire({ title: "Erreur", text: "Une erreur s'est produite.", icon: "error" });
        }
    });
}



function supprimerOffre(element, $id) {
     id = parseInt($id);
$_data = {
'id': $id
},
Swal.fire({
title: 'Êtes-vous sûr de vouloir supprimer cette offre ?',
type: 'warning',
showCancelButton: true,
confirmButtonColor: '#25a89d ',
cancelButtonColor: '#ff6b35',
confirmButtonText: 'Supprimer',
cancelButtonText: 'Annuler'
}).then((result) => {
if (result.value) {
$.ajax({
type: "POST",
url: "{{ path('admin_supprimer_offres') }}",
data: $_data,
success: function (response) {
element.parent().remove();
Swal.fire({title: "success!", text: "l'offre à été supprimer avec succés!", icon: "success"});


location.reload();
}
});
}
})
}

</script>
{% endblock %}
