{% extends 'vendeurNeuf/layoutVN.html.twig' %}

{% block Head %}
    {{ parent() }}
    {% block LinksCss %}
        {{ parent() }}
        <link rel="stylesheet" href="{{ asset('css/fontawesome.css') }}">
        <link rel="stylesheet" href="{{ asset('css/stylebutton.css') }}">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
    {% endblock %}
{% endblock %}

{% block title %}Proposer une offre{% endblock %}

{% block page %}
    {{ parent() }}

    {% if app.user and is_granted('ROLE_VENDEUR_NEUF') %}
        <div class="container my-5 px-4 px-md-5">
            <h3 class="mb-5 text-center fw-bold text-primary">
                Proposer une offre pour la demande {{ demande.code }}
            </h3>

            <form id="formOffre" method="POST" action="{{ path('offre_create', {'id': demande.id}) }}">
                {% for piece in demande.pieces %}
                    <div class="card mb-5 shadow-lg border-0 rounded-4 p-4" 
                         style="background: linear-gradient(135deg, #007bff, #00c6ff); color: #fff;">
                        <h4 class="fw-bold mb-4">{{ piece.designation }}</h4>

                        {# --- PRIX --- #}
                        <div class="row g-3 mb-2">
                            {% for i in 1..3 %}
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">PRIX UNITAIRE TTC {{ i }}ère Qualité</label>
                                    <input type="text" 
                                           name="pieces[{{ piece.id }}][prix{{ i }}]" 
                                           class="form-control rounded-3" 
                                           placeholder="Prix {{ i }}">
                                </div>
                            {% endfor %}
                        </div>

                        {# --- MARQUE --- #}
                        <div class="row g-3 mb-3">
                            {% for i in 1..3 %}
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">MARQUE {{ i }}ère Qualité</label>
                                    <input type="text" 
                                           name="pieces[{{ piece.id }}][marque{{ i }}]" 
                                           class="form-control rounded-3" 
                                           placeholder="Marque {{ i }}">
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}

                {# --- OBSERVATION + VALIDITÉ --- #}
                <div class="row g-3 mb-4">
                    <div class="col-md-8">
                        <label class="form-label fw-bold text-dark mb-2">Observation générale</label>
                        <textarea name="observation" placeholder="Saisissez vos remarques..." 
                                  class="form-control rounded-4 shadow-sm p-3" 
                                  style="background-color: #f0f2f5; border: 1px solid #ddd; height:120px;"></textarea>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-bold text-dark mb-2">Validité de l'offre</label>
                        <input type="text" name="validite" id="validite" 
                               class="form-control rounded-4 shadow-sm p-3" 
                               style="background-color: #f0f2f5; border: 1px solid #ddd;" 
                               placeholder="Choisir la date de validité">

                        <div class="d-grid p-3 mt-3">
                            <button type="submit" class="btn btn-primary btn-lg rounded-pill shadow-sm" 
                                    style="background: linear-gradient(90deg, #007bff, #00c6ff); border:none; font-weight:600;">
                                <i class="fas fa-paper-plane me-2"></i> Envoyer l'offre
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    {% endif %}
{% endblock %}

{% block javascript %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // Focus styling
            document.querySelectorAll('.form-control').forEach(el => {
                el.addEventListener('focus', () => {
                    el.style.borderColor = '#6a11cb';
                    el.style.boxShadow = '0 0 8px rgba(106,17,203,0.2)';
                });
                el.addEventListener('blur', () => {
                    el.style.borderColor = '#ddd';
                    el.style.boxShadow = 'none';
                });
            });

            // Initialisation du daterangepicker
          $('#validite').daterangepicker({
    autoUpdateInput: true,
    locale: {
        format: 'DD/MM/YYYY',
        applyLabel: 'Appliquer',
        cancelLabel: 'Annuler',
        daysOfWeek: ['Di', 'Lu', 'Ma', 'Me', 'Je', 'Ve', 'Sa'],
        monthNames: [
            'Janvier','Février','Mars','Avril','Mai','Juin',
            'Juillet','Août','Septembre','Octobre','Novembre','Décembre'
        ],
        firstDay: 1
    },
    opens: 'right',
    startDate: moment(),               // date de début par défaut
    endDate: moment().add(7, 'days')   // date de fin par défaut
});

            // Validation du formulaire
            const form = document.getElementById('formOffre');
            if (form) {
                form.addEventListener('submit', function(e) {
                    let valid = false;
                    const inputSuffixes = ['1','2','3'];

                    {% for piece in demande.pieces %}
                        inputSuffixes.forEach(suffix => {
                            if (!valid) {
                                let prixInput = document.querySelector(`input[name="pieces[{{ piece.id }}][prix${suffix}]"]`);
                                let marqueInput = document.querySelector(`input[name="pieces[{{ piece.id }}][marque${suffix}]"]`);
                                if (prixInput && marqueInput && prixInput.value.trim() && marqueInput.value.trim()) {
                                    valid = true;
                                }
                            }
                        });
                    {% endfor %}

                    if (!valid) {
                        e.preventDefault();
                        if (window.AIZ && AIZ.plugins && AIZ.plugins.notify) {
                            AIZ.plugins.notify('danger', 'Vous devez remplir au moins une combinaison prix + marque pour au moins une pièce.');
                        } else {
                            alert('Vous devez remplir au moins une combinaison prix + marque pour au moins une pièce.');
                        }
                    }
                });
            }

        });
    </script>
{% endblock %}
