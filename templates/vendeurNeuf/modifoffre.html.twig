{% extends 'vendeurNeuf/layoutVN.html.twig' %}

{% block Head %}
    {{ parent() }}
    {% block LinksCss %}
        {{ parent() }}
        <link rel="stylesheet" href="{{ asset('css/fontawesome.css') }}">
        <link rel="stylesheet" href="{{ asset('css/stylebutton.css') }}">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
    {% endblock %}
{% endblock %}

{% block title %}Modifier l'offre{% endblock %}

{% block page %}
    {{ parent() }}

    {% if app.user and is_granted('ROLE_VENDEUR_NEUF') %}
        <div class="container my-5 px-4 px-md-5">
            <h3 class="mb-5 text-center fw-bold text-primary">
                Modifier l'offre pour la demande {{ demande.code }}
            </h3>

            <form id="formOffre" method="POST" action="{{ path('offre_edit', {'numeroOffre': offre.numeroOffre}) }}">
                {% for piece in demande.pieces %}
                    {# Récupérer l'OffrePiece correspondant à cette pièce #}
                    {% set offrePiece = null %}
                    {% for op in offre.offrePieces %}
                        {% if op.piece.id == piece.id %}
                            {% set offrePiece = op %}
                        {% endif %}
                    {% endfor %}

                    <div class="card mb-5 shadow-lg border-0 rounded-4 p-4" 
                         style="background: linear-gradient(135deg, #007bff, #00c6ff); color: #fff;">
                        <h4 class="fw-bold mb-4">{{ piece.designation }}</h4>

                        {# --- PRIX --- #}
                        <div class="row g-3 mb-2">
                            {% for i in 1..3 %}
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">PRIX UNITAIRE TTC {{ i }}ère Qualité</label>
                                    <input type="text" 
                                           name="pieces[{{ piece.id }}][prix{{ i }}]" 
                                           class="form-control rounded-3" 
                                           placeholder="Prix {{ i }}"
                                           value="{{ offrePiece ? attribute(offrePiece, 'prix' ~ i) }}">
                                </div>
                            {% endfor %}
                        </div>

                        {# --- MARQUE --- #}
                        <div class="row g-3 mb-3">
                            {% for i in 1..3 %}
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">MARQUE {{ i }}ère Qualité</label>
                                    <input type="text" 
                                           name="pieces[{{ piece.id }}][marque{{ i }}]" 
                                           class="form-control rounded-3" 
                                           placeholder="Marque {{ i }}"
                                           value="{{ offrePiece ? attribute(offrePiece, 'marque' ~ i) }}">
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}

                {# --- OBSERVATION + VALIDITÉ --- #}
                <div class="row g-3 mb-4">
                    <div class="col-md-8">
                        <label class="form-label fw-bold text-dark mb-2">Observation générale</label>
                        <textarea name="observation" placeholder="Saisissez vos remarques..." 
                                  class="form-control rounded-4 shadow-sm p-3" 
                                  style="background-color: #f0f2f5; border: 1px solid #ddd; height:120px;">{{ offre.observation }}</textarea>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-bold text-dark mb-2">Validité de l'offre (une semaine ouvrable)</label>
                          <input type="text" name="validite" id="validite" 
                               class="form-control rounded-4 shadow-sm p-3" 
                               style="background-color: #f0f2f5; border: 1px solid #ddd;" 
                               placeholder="Choisir la date de validité">

                        <div class="d-grid p-3 mt-3">
                            <button type="submit" class="btn btn-primary btn-lg rounded-pill shadow-sm" 
                                    style="background: linear-gradient(90deg, #007bff, #00c6ff); border:none; font-weight:600;">
                                <i class="fas fa-paper-plane me-2"></i> Modifier l'offre
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    {% endif %}
{% endblock %}

{% block javascript %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialisation du daterangepicker avec sécurité pour les dates existantes
        var start = {% if offre.validiteDebut %}moment("{{ offre.validiteDebut|date('YYYY-MM-DD') }}"){% else %}moment(){% endif %};
        var end = {% if offre.validiteFin %}moment("{{ offre.validiteFin|date('YYYY-MM-DD') }}"){% else %}moment().add(7, 'days'){% endif %};

        $('#validite').daterangepicker({
    autoUpdateInput: true,
    locale: {
        format: 'DD/MM/YYYY',
        applyLabel: 'Appliquer',
        cancelLabel: 'Annuler',
        daysOfWeek: ['Di', 'Lu', 'Ma', 'Me', 'Je', 'Ve', 'Sa'],
        monthNames: [
            'Janvier','Février','Mars','Avril','Mai','Juin',
            'Juillet','Août','Septembre','Octobre','Novembre','Décembre'
        ],
        firstDay: 1
    },
    opens: 'right',
    startDate: moment(),               // date de début par défaut
    endDate: moment().add(7, 'days')   // date de fin par défaut
});

        // Validation des pièces avant envoi
        const form = document.getElementById('formOffre');
        if (form) {
            form.addEventListener('submit', function(e) {
                let formulaireValide = true;
                const pieces = document.querySelectorAll('[name^="pieces["]');
                let pieceIds = new Set();

                pieces.forEach(input => {
                    const match = input.name.match(/pieces\[(\d+)\]/);
                    if (match) pieceIds.add(match[1]);
                });

                pieceIds.forEach(pieceId => {
                    let combinaisonValide = false;
                    for (let i = 1; i <= 3; i++) {
                        let prix = document.querySelector(`input[name="pieces[${pieceId}][prix${i}]"]`);
                        let marque = document.querySelector(`input[name="pieces[${pieceId}][marque${i}]"]`);
                        if (prix && marque && prix.value.trim() && marque.value.trim()) {
                            combinaisonValide = true;
                            break;
                        }
                    }
                    if (!combinaisonValide) formulaireValide = false;
                });

                if (!formulaireValide) {
                    e.preventDefault();
                    alert('Chaque pièce doit avoir au moins une combinaison (prix + marque) remplie.');
                }
            });
        }
    });
    </script>
{% endblock %}
