{% extends 'layout.html.twig' %}

{% block title %}Essayara{% endblock %}

{% block Head %}
{{ parent() }}
{% block LinksCss %}
{{ parent() }}
<link rel="stylesheet" href="{{ asset('css/stylebutton.css') }}">
<style>
.user-item:hover { background-color: #f0f0f0; }

#chat-container {
    height:500px; overflow-y:auto; padding:10px;
    background:#f7f7f7; border-radius:12px;
    display:flex; flex-direction:column; gap:6px;
}
.msg-left, .msg-right {
    padding:10px 15px; border-radius:20px;
    max-width:75%; word-wrap: break-word;
    font-size:0.95rem;
}
.msg-left {
    background:#e4e6eb; color:#000;
    align-self:flex-start;
    border-radius:20px 20px 20px 0;
}
.msg-right {
    background:#0d6efd; color:#fff;
    align-self:flex-end;
    border-radius:20px 20px 0 20px;
}
#message-input-container {
    display:flex; gap:8px; margin-top:8px;
}
#message-input { flex:1; font-size:0.95rem; }

.user-list-container {
    height:400px; overflow-y:auto;
    padding:8px; background:#fff;
    border-radius:12px;
}

@media (max-width: 767px) {
    .row > .col-lg-4, .row > .col-lg-8 {
        flex:0 0 100%; max-width:100%;
    }
    #chat-container { height:300px; }
    .user-list-container { height:200px; margin-bottom:10px; }
    .msg-left, .msg-right { max-width:85%; }
}
</style>
{% endblock %}
{% endblock %}

{% block Content %}
{% block loader %}{{ parent() }}{% endblock %}

{% if app.user and is_granted('ROLE_PARTICULIER') %}
<section class="py-5" style="background:#f5f5f5;">
  <div class="container">
    <div class="row">

      <div class="col-lg-3">
        {% block sideHeader %}{{ parent() }}{% endblock %}
      </div>

      <div class="col-lg-9">
        <div class="bg-white rounded shadow-sm p-4">
          <h4 class="fw-bold mb-4">Mes messages</h4>

          {% if usersWithMessages is empty %}
            <p class="text-muted text-center py-5">Aucun message pour le moment.</p>
          {% endif %}

          <div class="row">

            <!-- âœ… Liste utilisateurs (lettre seulement) -->
            <div class="col-lg-4">
              <div class="bg-white rounded shadow-sm p-3 user-list-container">
                <ul class="list-group">
                  {% for entry in usersWithMessages %}
                    <li class="list-group-item user-item d-flex align-items-center p-2 mb-2 rounded"
                        data-user-id="{{ entry.user.id }}" style="cursor:pointer;">

                      <div class="me-2"
                           style="width:40px;height:40px;border-radius:50%;
                                  background:#ddd;display:flex;
                                  align-items:center;justify-content:center;font-weight:bold;">
                        {{ entry.user.nom|slice(0,1)|upper }}
                      </div>

                      <div>
                        <strong>{{ entry.user.nom }}</strong>
                        <p class="mb-0 text-truncate"
                           style="max-width:180px;font-size:0.9rem;color:#555;
                           {% if entry.lastMessage.isRead == false 
                                and entry.lastMessage.sender.id != app.user.id %}font-weight:bold;{% endif %}">
                          {{ entry.lastMessage.content|default('Aucun message') }}
                        </p>
                      </div>

                    </li>
                  {% endfor %}
                </ul>
              </div>
            </div>

            <!-- âœ… Chat -->
            <div class="col-lg-8 d-flex flex-column">
              <div id="chat-container">
                <p class="text-center text-muted mt-4">
                  ðŸ‘‰ Cliquez sur un utilisateur pour ouvrir la discussion
                </p>
              </div>

              <div id="message-input-container">
                <input type="text" id="message-input" class="form-control" placeholder="Ã‰crire un message...">
                <button class="btn btn-primary" id="send-btn">Envoyer</button>
              </div>
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>
</section>
{% endif %}
{% endblock %}

{% block javascript %}
{{ parent() }}
<script>
let selectedUserId = null;

function afficherMessages(data, senderId) {
    const container = document.getElementById('chat-container');
    container.innerHTML = '';

    if (!data.messages || data.messages.length === 0) {
        container.innerHTML = '<p class="text-center text-muted mt-4">Aucun message pour le moment</p>';
        return;
    }

    data.messages.forEach(msg => {
        const div = document.createElement('div');
        div.className = msg.senderId == senderId ? "msg-right" : "msg-left";

        // âœ… Image seulement si CE message a une photo
        if (msg.photo) {
            const img = document.createElement('img');
            img.src = msg.photo;
            img.style.maxWidth = '150px';
            img.style.borderRadius = '12px';
            img.style.display = 'block';
            img.style.marginBottom = '5px';
            div.appendChild(img);
        }

        if (msg.content) {
            const text = document.createElement('span');
            text.textContent = msg.content;
            div.appendChild(text);
        }

        container.appendChild(div);
    });

    container.scrollTop = container.scrollHeight;
}

// âœ… Click utilisateur
document.querySelectorAll('.user-item').forEach(el => {
    el.addEventListener('click', function () {
        selectedUserId = this.dataset.userId;

        fetch("{{ path('get_messages', {'receiverId': 0}) }}".replace('0', selectedUserId))
            .then(res => res.json())
            .then(data => afficherMessages(data, {{ app.user.id }}));

        fetch("{{ path('mark_as_read', {'senderId': 0}) }}".replace('0', selectedUserId), {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({})
        }).then(() => {
            const p = this.querySelector('p');
            if (p) p.style.fontWeight = 'normal';
        });
    });
});

// âœ… Envoyer message
document.getElementById('send-btn').addEventListener('click', function(){
    if (!selectedUserId) return;

    let content = document.getElementById('message-input').value;
    if (content.trim() === "") return;

    fetch("{{ path('part_message', {'receiverId': 0}) }}".replace('0', selectedUserId), {
        method:"POST",
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:'content=' + encodeURIComponent(content)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            document.getElementById('message-input').value = "";
            fetch("{{ path('get_messages', {'receiverId': 0}) }}".replace('0', selectedUserId))
                .then(res => res.json())
                .then(data => afficherMessages(data, {{ app.user.id }}));
        }
    });
});
</script>
{% endblock %}
