{% extends 'vendeurNeuf/layoutVN.html.twig' %}

{% block Head %}
    {{ parent() }}
    {% block LinksCss %}
        {{ parent() }}
        <link rel="stylesheet" href="{{ asset('css/fontawesome.css') }}">
        <link rel="stylesheet" href="{{ asset('css/stylebutton.css') }}">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
    {% endblock %}
{% endblock %}

{% block title %}Proposer une offre{% endblock %}

{% block page %}
    {{ parent() }}

    {% if app.user and is_granted('ROLE_VENDEUR_NEUF') %}
        <div class="container my-5 px-4 px-md-5">
            <h3 class="mb-5 text-center fw-bold text-primary">Proposer une offre pour la demande {{ demande.code }}</h3>

            <form method="POST" action="{{ path('offre_create', {'id': demande.id}) }}">
                {% for piece in demande.pieces %}
                    <div class="card mb-5 shadow-lg border-0 rounded-4 p-4" 
                         style="background: linear-gradient(135deg, #007bff, #00c6ff); color: #fff;">
                        <h4 class="fw-bold mb-4">{{ piece.designation }}</h4>

                        {# --- PRIX --- #}
                        <div class="row g-3 mb-2">
                            {% for i in 1..3 %}
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">PRIX UNITAIRE TTC {{ i }}ère Qualité</label>
                                    <input type="text" name="pieces[{{ piece.id }}][prix{{ i }}]" 
                                           class="form-control rounded-3" placeholder="Prix {{ i }}">
                                </div>
                            {% endfor %}
                        </div>

                        {# --- MARQUE --- #}
                        <div class="row g-3 mb-3">
                            {% for i in 1..3 %}
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">MARQUE {{ i }}ère Qualité</label>
                                    <input type="text" name="pieces[{{ piece.id }}][marque{{ i }}]" 
                                           class="form-control rounded-3" placeholder="Marque {{ i }}">
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}

                {# --- OBSERVATION + VALIDITÉ --- #}
                <div class="row g-3 mb-4">
                    <div class="col-md-8">
                        <label class="form-label fw-bold text-dark mb-2">Observation générale</label>
                        <textarea name="observation" placeholder="Saisissez vos remarques..." 
                                  class="form-control rounded-4 shadow-sm p-3" 
                                  style="background-color: #f0f2f5; border: 1px solid #ddd; height:120px; transition: 0.3s;"></textarea>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-bold text-dark mb-2">Validité de l'offre</label>
                        <input type="text" name="validite" id="validite" class="form-control rounded-4 shadow-sm p-3" 
                               style="background-color: #f0f2f5; border: 1px solid #ddd; transition: 0.3s;" 
                               placeholder="Choisir la date de validité">

                        <div class="d-grid p-3 mt-3">
                            <button type="submit" class="btn btn-primary btn-lg rounded-pill shadow-sm" 
                                    style="background: linear-gradient(90deg, #007bff, #00c6ff); border:none; font-weight: 600;">
                                <i class="fas fa-paper-plane me-2"></i> Envoyer l'offre
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    {% endif %}
{% endblock %}

{% block javascript %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

    <script>
        // Focus effect
        document.querySelectorAll('.form-control').forEach(el => {
            el.addEventListener('focus', () => {
                el.style.borderColor = '#6a11cb';
                el.style.boxShadow = '0 0 8px rgba(106,17,203,0.2)';
            });
            el.addEventListener('blur', () => {
                el.style.borderColor = '#ddd';
                el.style.boxShadow = 'none';
            });
        });

        // Date range picker
        $(function() {
            $('#validite').daterangepicker({
                opens: 'right',
                locale: { format: 'DD/MM/YYYY' },
                autoUpdateInput: true
            });
        });



document.querySelector('form').addEventListener('submit', function(e) {
    let valid = false;

    {% for piece in demande.pieces %}
        // On récupère les 3 prix et 3 marques pour cette pièce
        let prix1 = document.querySelector('input[name="pieces[{{ piece.id }}][prix1]"]').value.trim();
        let marque1 = document.querySelector('input[name="pieces[{{ piece.id }}][marque1]"]').value.trim();
        let prix2 = document.querySelector('input[name="pieces[{{ piece.id }}][prix2]"]').value.trim();
        let marque2 = document.querySelector('input[name="pieces[{{ piece.id }}][marque2]"]').value.trim();
        let prix3 = document.querySelector('input[name="pieces[{{ piece.id }}][prix3]"]').value.trim();
        let marque3 = document.querySelector('input[name="pieces[{{ piece.id }}][marque3]"]').value.trim();

        // Vérification : au moins une combinaison prixX + marqueX remplie
        if ((prix1 && marque1) || (prix2 && marque2) || (prix3 && marque3)) {
            valid = true;
        }
    {% endfor %}

    if (!valid) {
        e.preventDefault();
        AIZ.plugins.notify('danger', 'Vous devez remplir au moins une combinaison prix + marque pour au moins une pièce.');
    }
});




    </script>
{% endblock %}
