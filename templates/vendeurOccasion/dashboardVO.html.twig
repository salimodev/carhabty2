{% extends 'vendeurOccasion/layoutVO.html.twig' %}
{% block Head %}
	{{ parent() }}

	{% block LinksCss %}
		{{ parent() }}
		<link rel="stylesheet" href="{{ asset ('css/carousel.css') }}">
		<link rel="stylesheet" href="{{ asset ('css/carouselle.css') }}">
		<link rel="stylesheet" href="{{ asset ('css/fontawesome.css') }}">
       <style>
.card-gradient {
	border: none;
	border-radius: 1rem;
	color: #fff;
	box-shadow: 0 5px 20px rgba(0,0,0,0.15);
}
.bg-gradient-primary {
	background: linear-gradient(135deg, #007bff 0%, #00c6ff 100%);
}
.bg-gradient-success {
	background: linear-gradient(135deg, #28a745 0%, #85e085 100%);
}
.bg-gradient-info {
	background: linear-gradient(135deg, #17a2b8 0%, #5bc0de 100%);
}
.bg-gradient-warning {
	background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%);
}
.card-gradient i {
	opacity: 0.85;
}
</style>
	{% endblock %}

{% endblock %}

{% block title %}Tableau de bord
{% endblock %}
{% block Header %}
	{{ parent() }}
{% endblock %}


{% block page %}
	{{ parent() }}
	{% block loader %}
		{{ parent() }}
	{% endblock %}
<div class="px-15px px-lg-25px">
	<div class="aiz-titlebar mt-2 mb-4">
		<div class="row align-items-center">
			<div class="col-md-6">
				<h1 class="h3 text-primary">Tableau de bord</h1>
			</div>
		</div>
	</div>

	<div class="row g-4">
		<div class="col-sm-6 col-md-6 col-xxl-3">
			<div class="card card-gradient bg-gradient-primary py-4">
				<div class="card-body d-flex justify-content-between align-items-center">
					<div>
						<p class=" mb-1">
							<i class="fas fa-clipboard-list me-1"></i>
							Demandes disponibles</p>
						<h3 class="mb-0 fs-30">{{ countDemandes }}</h3>
					</div>
					<div class="text-end">
						<i class="fas fa-search fa-3x"></i>
					</div>
				</div>
			</div>
		</div>

		<div class="col-sm-6 col-md-6 col-xxl-3">
			<div class="card card-gradient bg-gradient-success py-4">
				<div class="card-body d-flex justify-content-between align-items-center">
					<div>
						<p class=" mb-1">
							<i class="fas fa-paper-plane me-1"></i>
							Offres envoyées</p>
						<h3 class="mb-0 fs-30">{{ nombreOffres }}</h3>
					</div>
					<div class="text-end">
						<i class="fas fa-envelope-open-text fa-3x"></i>
					</div>
				</div>
			</div>
		</div>

		<div class="col-sm-6 col-md-6 col-xxl-3">
			<div class="card card-gradient bg-gradient-info py-4">
				<div class="card-body d-flex justify-content-between align-items-center">
					<div>
						<p class=" mb-1">
							<i class="fas fa-check-circle me-1"></i>
							Offres acceptées</p>
						<h3 class="mb-0 fs-30">{{ nbOffresAcceptees }}</h3>
					</div>
					<div class="text-end">
						<i class="fas fa-handshake fa-3x"></i>
					</div>
				</div>
			</div>
		</div>

		<div class="col-sm-6 col-md-6 col-xxl-3">
			<div class="card card-gradient bg-gradient-warning py-4">
				<div class="card-body d-flex justify-content-between align-items-center">
					<div>
						<p class=" mb-1">
							<i class="fas fa-chart-line me-1"></i>
							Taux d’acceptation</p>
						<h3 class="mb-0 fs-30">{{tauxAcceptation}}%</h3>
					</div>
					<div class="text-end">
						<i class="fas fa-percentage fa-3x"></i>
					</div>
				</div>
			</div>
		</div>
	</div>


	<br>
	<div class="row">
		<div class="col-md-12">
			<div class="card">
				<div class="card-header">
					<h5 class="mb-0 h6">Dernières demandes reçues</h5>
				</div>
				<div class="card-body">
					<table id="tabprod" style="width:100%">
						<thead>
							<tr>
								<th>Code</th>
								<th>Marque</th>
								<th>Modèle</th>
								<th>N° Châssis</th>
								<th>Énergie</th>
								<th>État moteur</th>
								<th>Lieu</th>
								<th>Date</th>
								<th>Status</th>
								<th>Action</th>
							</tr>
						</thead>
						<tbody>
							{% for demande in demandes %}
								<tr>
									<td>
										<a href="{{path('detail_demande_vendeur_occa',{'id':demande.id})}}">{{ demande.code }}</a>
									</td>
									<td>{{ demande.marque }}</td>
									<td>{{ demande.modele }}</td>
									<td>{{ demande.chassis }}</td>
									<td>{{ demande.energie }}</td>
									<td>{{ demande.etatmoteur }}</td>
									<td>{% if demande.offrecompte %}
        {{demande.offrecompte.adresse }}
    {% else %}
       {{ demande.zone }}
    {% endif %} </td>
									<td>{{ demande.datecreate|date('d/m/Y H:i') }}</td>
									<td>
										{% if demande.statut == 'ouvert' %}
											<span class="badge badge-inline badge-success">ouvert</span>
										{% elseif demande.statut == 'fermer' %}
											<span class="badge badge-inline badge-danger">fermé</span>
										{% endif %}
									</td>
									<td class="text-right">
										<a class="btn btn-soft-success btn-icon btn-circle btn-sm" href="{{path('detail_demande_vendeur_occa',{'id':demande.id})}}" title="Voir détail">
											<i class="las la-eye"></i>
										</a>


									</td>

								</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>

	<div class="row">
		<div class="col-md-12">
			<div class="card">
				<div class="card-header">
					<h5 class="mb-0 h6">Dernières offres envoyées</h5>
				</div>
				<div class="card-body">
					{% if dernieresOffres is not empty %}
						<table class="table table-hover mb-0 align-middle" id="tabprod1">
							<thead class="table-light">
								<tr>
									<th>#</th>
									<th>Numéro</th>
									<th>Demande</th>
									<th>Demandeur</th>
									<th>Observation</th>
									<th>Date d’envoi</th>
									<th>Validité</th>
									<th>Statut</th>
									<th>Action</th>
								</tr>
							</thead>
							<tbody>
								{% for offre in dernieresOffres %}
									<tr>
										<td>{{ loop.index }}</td>
										<td class="fw-semibold text-primary">{{ offre.numeroOffre }}</td>
										<td>
											<a href="{{ path('detail_demande_vendeur', {'id': offre.demande.id}) }}" class="text-decoration-none text-dark fw-semibold">
												{{ offre.demande.code ?? '—' }}
											</a>
										</td>
										 {# ✅ Affichage du nom ou email du demandeur #}
          <td>
    {% if offre.demande.offrecompte %}
        {{ offre.demande.offrecompte.nom ?? offre.demande.offrecompte.email }}
    {% else %}
        <span class="text-muted"> {{ offre.demande.offreemail }}</span>
    {% endif %}
</td>

										<td>
											{{ offre.observation|length > 40 
                                            ? offre.observation|slice(0, 40) ~ '...' 
                                            : offre.observation }}
										</td>
										<td>{{ offre.createdAt|date('d/m/Y H:i') }}</td>
										<td>
											{% if offre.joursRestants > 0 %}
												{{ offre.joursRestants }}
												jour{{ offre.joursRestants > 1 ? 's' : '' }}
											{% else %}
												Expirée
											{% endif %}
										</td>
										<td>
    {% if offre.status == 'acceptee' %}
        <span class="badge badge-inline badge-success">Acceptée</span>
    {% elseif offre.status == 'refusee' %}
        <span class="badge badge-inline badge-danger">Refusée</span>
    {% else %}
        <span class="badge badge-inline badge-warning text-dark">En attente</span>
    {% endif %}
</td>
                                    <td class="text-right">
    {% if offre.status == 'en_attente' %}
        <a href="{{ path('offre_edit_occ', {'id': offre.id}) }}" 
           class="btn btn-soft-warning btn-icon btn-circle btn-sm" 
           title="Modifier">
            <i class="las la-edit"></i>
        </a>
        <a href="#" class="btn btn-soft-danger btn-icon btn-circle btn-sm"
           title="Supprimer"
           onclick="supprimerOffre($(this), {{ offre.id }})">
            <i class="las la-trash"></i>
        </a>
    {% endif %}

    {# Nouveau bouton "Voir l'offre" disponible pour tous les statuts #}
    <a href="{{ path('offre_show_occ', {'id': offre.id}) }}" 
       class="btn btn-soft-info btn-icon btn-circle btn-sm" 
       title="Voir l'offre">
        <i class="las la-eye"></i>
    </a>

    {% if offre.status == 'acceptee' %}
        <a href="#" class="btn btn-soft-success btn-icon btn-circle btn-sm"
           title="Offre acceptée" disabled>
            <i class="las la-check"></i>
        </a>
    {% elseif offre.status == 'refusee' %}
        <a href="#" class="btn btn-soft-danger btn-icon btn-circle btn-sm"
           title="Offre refusée" disabled>
            <i class="las la-times"></i>
        </a>
    {% endif %}
</td>


									</tr>
								{% endfor %}
							</tbody>
						</table>
					{% else %}
						<p class="text-center text-muted">Aucune offre envoyée récemment.</p>
					{% endif %}
				</div>
			</div>
		</div>
	</div>


</div></div></div>

{% endblock %}{% block footer %}{{ parent() }}{% endblock %}{% block javascript %}{{ parent() }}<script type="text/javascript" src="{{asset ('assets/js/carousel.js') }}"></script><script src="https://cdn.jsdelivr.net/npm/chart.js"></script><script type="text/javascript"></script><script type="text/javascript">
$(document).ready(function () {
var table = $('#tabprod').DataTable({
language: {
processing: "Traitement en cours...",
search: "Rechercher :",
lengthMenu: "Afficher _MENU_ éléments",
info: " _START_-_END_/_TOTAL_ éléments",
infoEmpty: " 0 -  0 / 0 éléments",
infoFiltered: "(filtré de _MAX_ éléments au total)",
infoPostFix: "",
loadingRecords: "Chargement en cours...",
zeroRecords: "Aucun élément à afficher",
emptyTable: "Aucun élément à afficher",
paginate: {
first: "Premier",
previous: "Précédent",
next: "Suivant",
last: "Dernier"
}
},
rowReorder: {
selector: 'td:nth-child(2)'
},
responsive: true
});
});


$(document).ready(function () {
var table = $('#tabprod1').DataTable({
language: {
processing: "Traitement en cours...",
search: "Rechercher :",
lengthMenu: "Afficher _MENU_ éléments",
info: " _START_-_END_/_TOTAL_ éléments",
infoEmpty: " 0 -  0 / 0 éléments",
infoFiltered: "(filtré de _MAX_ éléments au total)",
infoPostFix: "",
loadingRecords: "Chargement en cours...",
zeroRecords: "Aucun élément à afficher",
emptyTable: "Aucun élément à afficher",
paginate: {
first: "Premier",
previous: "Précédent",
next: "Suivant",
last: "Dernier"
}
},
rowReorder: {
selector: 'td:nth-child(2)'
},
responsive: true
});
});

function PasdeStore() {
AIZ.plugins.notify('warning', "vous n'avez pas un store");
}

function dejaeffectue() {
AIZ.plugins.notify('warning', "vous avez déja effectuer une vérification");
}
function verfier() {
AIZ.plugins.notify('warning', "Il faut que votre store doit etre verfier!");
}


function supprimerOffre(element, $id) {
$_data = {
'id': $id
},
Swal.fire({
title: 'Êtes-vous sûr de vouloir supprimer cette demande ?',
type: 'warning',
showCancelButton: true,
confirmButtonColor: '#25a89d ',
cancelButtonColor: '#ff6b35',
confirmButtonText: 'Supprimer',
cancelButtonText: 'Annuler'
}).then((result) => {
if (result.value) {
$.ajax({
type: "POST",
url: "{{ path('retirer_offre_occ') }}",
data: $_data,
success: function (response) {
element.parent().remove();
Swal.fire({title: "success!", text: "l'offre à été supprimer avec succés!", icon: "success"});


location.reload();
}
});
}
})
}


</script>{% endblock %}

